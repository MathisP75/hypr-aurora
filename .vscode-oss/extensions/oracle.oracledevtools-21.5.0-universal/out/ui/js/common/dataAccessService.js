define(["require","exports","jquery","./localizedConstants","./models","./scriptExecutionModels","./odtUtils"],(function(require,e,t,s,i,a,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.DataAccessService=void 0;class d{constructor(){this.requestId=0,this.batchSize=100,this.readyToSend=!1,this.selectColumnWidth=40,this.receiver=new i.CustomEventEmitter,this.SEND_MESSAGE_REQUEST="sendMessageRequest",this.MESSAGE_RECEIVED_EVENT="messageReceivedEvent",this.sender=new i.CustomEventEmitter,this.saveHandlerMapping=new Map,this.addSaveDataOutcomeHandler=(e,t,s)=>{this.saveHandlerMapping.set(this.getQueryIdQueryResultIdIdentifier(e,t),s)},this.URI=this.getElementValue("scriptPath"),this.encodedURI=encodeURI(this.URI),this.currentExecutionId=this.getElementValue("executionId"),this.locale=this.getElementValue("locale"),this.displayMode=this.getElementValue("uiMode"),this.windowUri=this.getElementValue("windowUri"),this.documentUri=this.getElementValue("documentUri"),this.connectionName=this.getElementValue("connectionName"),this.adbDatabaseID=this.getElementValue("adbDatabaseID"),this.adbDisplayName=this.getElementValue("adbDisplayName"),this.adbName=this.getElementValue("adbName"),this.walletLocation=this.getElementValue("walletLocation"),this.dataBatchSize=this.getElementValue("dataBatchSize"),this.profileName=this.getElementValue("profileName"),this.currentRegion=this.getElementValue("regionName"),this.compartmentName=this.getElementValue("compartmentName"),this.compartmentFullPath=this.getElementValue("compartmentFullPath"),this.adbWorkLoadType=this.getElementValue("adbWorkLoadType"),this.isDedicatedDb="true"===this.getElementValue("isDedicatedDb"),this.tlsAuthenticationType=this.getElementValue("tlsAuthType"),this.readyToSend=!1,this.moveDefaultStyleToEndOfHead(),this.windowUri||(this.windowUri=this.URI),this.useMinified="true"===this.getElementValue("useMinified"),window.addEventListener("message",e=>{this.readyToSend||(this.readyToSend=!0,this.sendUpdateStatusEvent(),n.ODTUtils.sendUpdateToolbarEvent(d.instance.currentExecutionStatus)),e.data&&e.data.type?(d.instance.logInfo("Received Message "+JSON.stringify(e.data.type)),this.receiver.emit(this.MESSAGE_RECEIVED_EVENT,e.data)):console.warn("Unknown Message "+JSON.stringify(e))});const e=acquireVsCodeApi();this.sender.on(this.SEND_MESSAGE_REQUEST,t=>{t&&e.postMessage(t)}),this.subscribe(e=>{if(e&&e.type===a.OracleEventNames.saveQueryResultFinishedEvent){const t=e.data.queryId,s=e.data.queryResultId,i=this.saveHandlerMapping.get(this.getQueryIdQueryResultIdIdentifier(t,s));i&&i(e.data)}else d.instance.logError("Could not find handler for message "+t.type)});const t=new a.MessageBase;t.type=a.MessageName.receiverReady;const s=new a.ReceiverReadyEvent;s.ownerUri=this.windowUri,s.executionId=this.currentExecutionId,t.data=s,this.send(t)}moveDefaultStyleToEndOfHead(){const e=document.getElementById("_defaultStyles");if(e){let t=e.parentElement;t.removeChild(e),t.appendChild(e)}}pageSize(){return this.dataBatchSize<=3?3:this.dataBatchSize}mappedQualifier(e){switch(e){case"None":return"";case' " " Double quotes':return'"';case" ' ' Single quotes":return"'";default:return""}}sendUpdateStatusEvent(){d.instance.logInfo("Sending Update Status event - "+d.instance.URI);const e=new a.MessageBase;e.type=a.MessageName.updateStatusBarEvent;const t=new a.UpdateStatusBarEvent;t.executionId=d.instance.currentExecutionId,t.ownerUri=d.instance.URI,t.windowUri=d.instance.windowUri,e.data=t,this.send(e)}sendTestCommandResponse(e){const t=new a.MessageBase;t.type=a.MessageName.testCommandResponse,t.data=e,this.send(t)}static get instance(){return d.instanceField||(d.instanceField=new d),d.instanceField}generateRequestId(){return this.requestId=this.requestId+1,this.requestId}subscribe(e){this.receiver.on(this.MESSAGE_RECEIVED_EVENT,e)}send(e){this.sender.emit(this.SEND_MESSAGE_REQUEST,e)}getDataBatch(e){e.ownerUri=this.URI,e.executionId=e.executionId;const t=new a.MessageBase;return t.type=a.MessageName.getDataBatch,t.data=e,this.send(t)}getLocalizedData(){const e=(new s.LocalizationFileMapping).getLocalizationFilePath(this.locale);return t.get(e)}cancelQuery(e){const t=new a.MessageBase;return t.type=a.MessageName.cancelQuery,t.data=e,this.send(t)}logInfo(e){this.log(e,a.LogLevel.Information)}sendUserInput(e){e.ownerUri=this.URI;const t=new a.MessageBase;return t.type=a.MessageName.consumeUserInputRequest,t.data=e,this.send(t)}logError(e){this.log(e,a.LogLevel.Error)}updatedConfig(e){this.logLevel=e.logLevel,this.loggingEnabled=e.loggingEnabled,this.dataBatchSize=e.dataBatchSize,this.csvDelimiter=e.csvDelimiter,this.csvQualifier=this.mappedQualifier(e.csvQualifier)}getQueryIdQueryResultIdIdentifier(e,t){return e+"/"+t}getElementValue(e){let t="";const s=document.getElementById(e);return s&&s.innerText&&"undefined"!==s.innerText&&(t=s.innerText.trim()),t}log(e,t){if(this.loggingEnabled&&t<=this.logLevel){const s=new a.MessageBase;s.type=a.MessageName.logData;const i=new a.LogMessage;i.level=t,i.data=e,s.data=i,this.sender.emit(this.SEND_MESSAGE_REQUEST,s)}}}e.DataAccessService=d}));
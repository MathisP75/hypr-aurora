define(["require","exports","knockout","ojs/ojarraydataprovider","ojs/ojcontext","ojs/ojknockouttemplateutils","../common/dataAccessService","../common/localizedConstants","../common/messageService","../common/models","../common/scriptExecutionModels","../utilities","../common/odtUtils","ojs/ojbutton","ojs/ojoption","ojs/ojprogress","ojs/ojselectcombobox","ojs/ojtable","ojs/ojinputtext","ojs/ojpopup","ojs/ojmenu","ojs/ojprogress-circle"],(function(require,e,t,s,a,i,o,l,n,r,c,d,h){"use strict";var u,g,p;return function(e){e[e.None=0]="None",e[e.Up=1]="Up",e[e.Down=2]="Down"}(u||(u={})),function(e){e[e.None=0]="None",e[e.Propagate=1]="Propagate",e[e.Reflect=2]="Reflect"}(g||(g={})),function(e){e[e.None=0]="None",e[e.Selected=1]="Selected",e[e.All=2]="All"}(p||(p={})),class{constructor(e){this.noData=null,this.saveValue=t.observable(p.Selected),this.saveAllValue=t.observable(p.All),this.columnsDefault={template:"cellTemplate",sortable:"none",resizable:"enabled",headerRenderer:i.getRenderer("headerColumn",!0)},this.masterToggleValue=t.observable(!0),this.pagingNeeded=!0,this.displayedColumns=[],this.dataVisible=t.observableArray(["true"]),this.queryVisible=t.observableArray([]),this.policyOptions={fetchSize:25,maxCount:25},this.scrollPolicy="loadAll",this.selectAllValue=t.observable(c.RowSelection.SelectAll),this.formats=t.observableArray([{value:c.DataFormat.CSV,label:c.DataFormat[c.DataFormat.CSV]},{value:c.DataFormat.JSON,label:c.DataFormat[c.DataFormat.JSON]}]),this.selectPageMenuItems=[{value:c.RowSelection.SelectAllInPage,label:l.LocalizedConstants.Instance.selectAllRowsOnPage},{value:c.RowSelection.UnselectAllInPage,label:l.LocalizedConstants.Instance.unselectAllRowsOnPage}],this.selectAllMenuItems=[{value:c.RowSelection.SelectAll,label:l.LocalizedConstants.Instance.selectAllRows},{value:c.RowSelection.UnselectAll,label:l.LocalizedConstants.Instance.unselectAllRows}],this.selectedSaveFormat=t.observable(c.DataFormat.CSV),this.showSQLField=t.observable(!1),this.saveModes=t.observableArray([p.Selected,p.All]),this.isSaving=t.observable(!1),this.isCopying=t.observable(!1),this.scrollPosValue=t.observable({x:0,y:0}).extend({rateLimit:{timeout:400}}),this.showAllSQL=t.observableArray([]),this.pendingRequestCount=t.observable(0),this.includeHeaderField=!0,this.includeNewLineField=!0,this.previousScrollTop=0,this.scrollDecrement=5,this.ignoreChildrenNotification=!1,this.ShowRowsLimited=t.observable(!1),this.RowsLimitedText=t.observable(""),this.messageHandlers=new Map,this.handleSave=()=>{this.selectionValid()?this.saveOrCopyData(p.Selected):n.MessagesService.getinstance().ShowMessage(l.LocalizedConstants.Instance.selectOneOrMoreRowsForOperationToPerform,r.Severity.info)},this.handleSaveAll=()=>{this.saveOrCopyData(p.All)},this.cancelSaveHandler=()=>{const e=new c.MessageBase;e.type=c.OracleEventNames.scriptSaveQueryResultCancelRequest;const t=new c.SaveQueryResultCancelRequestParams;t.queryId=this.dataSource.queryId,t.queryResultId=this.dataSource.queryResultId,t.ownerUri=o.DataAccessService.instance.URI,t.executionId=this.dataSource.executionId,e.data=t,o.DataAccessService.instance.send(e)},this.updateMasterSelectValue=e=>{if(this.pagingNeeded)this.selectAllValue()==c.RowSelection.SelectAll?this.selectAll(c.RowSelection.SelectAll):this.unselectAll(c.RowSelection.UnselectAll);else{const t=e.srcElement.checked;this.setMasterToggle(g.Propagate,t)}},this.onNavArrowClick=e=>{let t=this.pageModel.curPageNo;switch(o.DataAccessService.instance.logInfo("Processing '"+e+"' click from page "+t),e){case"First":t=1;break;case"Next":t=this.pageModel.curPageNo+1;break;case"Prev":t=this.pageModel.curPageNo-1;break;case"Last":t=this.pageModel.lastPageNo}this.validateAndGotoPage(t),o.DataAccessService.instance.logInfo("Finished processing '"+e+"' click")},this.onRowSelectionAction=e=>{if(e&&e.detail){let t=e.detail.selectedValue;t===c.RowSelection.SelectAllInPage?(this.selectAll(t),document.getElementById("opt_0").firstElementChild.setAttribute("href","#/")):t===c.RowSelection.UnselectAllInPage&&(this.unselectAll(t),document.getElementById("opt_1").firstElementChild.setAttribute("href","#/"))}},this.preventPageChange=()=>{this.pageModel.setToPrevPageNo()},this.pageInputValidation=e=>{if(e)if("Enter"==e.key)o.DataAccessService.instance.logInfo("Input box: jump to page "+this.pageModel.inputPageNo()),this.validateAndGotoPage(this.pageModel.inputPageNo()),o.DataAccessService.instance.logInfo("Input box: page "+this.pageModel.inputPageNo()+" processed");else{if(e.key.length>1)return;let t=e.key.replace(/[^0-9]/g,"");e.key!==t&&(e.returnValue=!1)}},this.onPaste=e=>{let t=e.clipboardData.getData("Text"),s=t.replace(/[^0-9]/g,"");t!==s&&e.preventDefault()},this.startAnimationListener=e=>{let t=e.detail;"open"!==t.action&&"close"!==t.action||(e.preventDefault(),t.endCallback())},this.preventDefault=e=>{e.preventDefault()},this.preventTableAnimation=e=>{let t=e.detail;e.preventDefault(),t.endCallback()},this.disableInput=e=>{"Tab"!=e.key&&(e.returnValue=!1)},this.copyCellData=e=>{const t=e.currentTarget.firstElementChild;let s=t.value,a=s.substr(s.indexOf(":")+1);this.copyToClipBoard(a);const i=t.firstChild;i&&i.setAttribute("href","#/")},this.addCellHighlight=e=>{let t=e.currentTarget.firstElementChild.value,s=t.substr(0,t.indexOf(":"));const a=document.getElementById("cellContainer_"+s);a&&a.parentElement&&a.parentElement.classList.add("cell-focus")},this.removeCellHighlight=()=>{$(".cell-focus").removeClass("cell-focus")},this.closeContextMenuIfOpen=()=>{const e=document.getElementsByClassName("copyMenu");for(var t=0;t<e.length;++t)e[t].close()},this.checkCellContext=e=>{const t=e.detail.originalEvent.target,s=e.currentTarget,a=s.parentElement,i=a.getContextByNode(t);if(null!=i)if("oj-table-header"===i.subId)e.preventDefault();else if("oj-table-cell"===i.subId)if(0==i.columnIndex)e.preventDefault();else{let t=a.getDataForVisibleRow(i.rowIndex).data,o=a.columns[i.columnIndex].field,l=this.uiMode==c.UIDisplayMode.ShowData?t[o]:t()[o],n=a.id+"_"+i.rowIndex+"_"+i.columnIndex;""==l||null===l?e.preventDefault():s.firstElementChild.value=n+":"+l}},this.mouseUpListener=e=>{if(e.srcElement.id===this.tableContainerId&&e){const e=$(this.moduleView).find("#"+this.tableContainerId).first()[0],t=$(this.moduleView).find("#"+this.tableId).first()[0],s=$(this.moduleView).find(`#${this.tableId}  tbody`).first()[0],a=e,i=t;a.clientHeight>=s.scrollHeight?(i.style.height=this.toPx(i.scrollHeight),a.style.height=this.toPx(i.scrollHeight+10)):(i.style.height=this.toPx(a.clientHeight-10),a.style.height=this.toPx(a.clientHeight))}},this.toPx=e=>e+"px",this.getValue=e=>{let t=e;const s=e.indexOf("px");return s>-1&&(t=Number.parseInt(e.substring(0,s))),t},this.copyAllToClipBoard=()=>{this.selectionValid()?(this.saveOrCopyData(p.Selected,!1),o.DataAccessService.instance.logInfo("copying to clipboard")):n.MessagesService.getinstance().ShowMessage(l.LocalizedConstants.Instance.selectOneOrMoreRowsForOperationToPerform,r.Severity.info)},this.toggleQuery=()=>{this.showQuery=!this.showQuery},this.saveOrCopyData=(e,t=!0)=>{t?this.isSaving(!0):this.isCopying(!0);const s=new c.MessageBase;s.type=c.MessageName.saveAllRequest;const a=new c.SaveQueryResultRequestParams;a.queryId=this.dataSource.queryId,a.queryResultId=this.dataSource.queryResultId,a.ownerUri=o.DataAccessService.instance.URI,a.executionId=this.dataSource.executionId,a.bindVariableId=this.dataSource.bindVariableId,a.fileFormat=this.selectedSaveFormat(),this.selectedSaveFormat()==c.DataFormat.CSV&&(a.csvOptions=new Array(2),a.csvOptions[0]=o.DataAccessService.instance.csvDelimiter,a.csvOptions[1]=o.DataAccessService.instance.csvQualifier,s.data=a),a.saveDataToFile=t,s.data=a,e===p.Selected?(a.saveType=c.SaveType.Indexes,a.indexes=this.dataSource.getSelection()):e===p.All&&(a.saveType=c.SaveType.All),o.DataAccessService.instance.send(s)},this.onSaveAllResultEvent=e=>{e.saveDataToFile?this.isSaving(!1):this.isCopying(!1),e.messageType===c.SaveQueryResultMessageType.Error?n.MessagesService.getinstance().ShowMessage(e.message,r.Severity.error):e.messageType===c.SaveQueryResultMessageType.Message&&(e.saveDataToFile?n.MessagesService.getinstance().ShowMessage(e.message):n.MessagesService.getinstance().ShowMessage(`${l.LocalizedConstants.Instance.copied} ${this.dataSource.selection.size} ${l.LocalizedConstants.Instance.rowsToClipBoard}`,r.Severity.info))},this.handleScrollPositionChanged=e=>{if(e&&e.detail&&e.detail.originalEvent&&e.detail.originalEvent.target){const t=e.detail.originalEvent.target,s=new r.ScrollEventArgs(t.scrollHeight,t.scrollTop,t.clientHeight);return this.onScroll(s),!0}},this.uiMode=e.uiMode,this.dataSource=e.gridData,this.moduleRenderingCompleted=e.moduleRenderingCompleted,this.modulePageSize=o.DataAccessService.instance.pageSize(),this.nextBatchId=this.dataSource.batchId-1,this.uiMode==c.UIDisplayMode.ShowData?(this.divStyle={height:"100%"},this.gridStyle=t.observable({width:"100%","max-height":"90vh"}),this.scrollPolicy="loadMoreOnScroll",this.policyOptions.fetchSize=d.showDataFetchSize,this.policyOptions.maxCount=this.dataSource.MaxRowsCount,this.matDataSource=new s(this.dataSource.rows,{keyAttributes:"RowNum:"+(this.dataSource.columns.length-1)}),this.pagingNeeded=!1):(this.divStyle={"margin-bottom":"10px"},this.gridStyle=t.observable({width:"100%",height:"100%"}),this.setPagingControls());for(let e=this.modulePageSize+1;e<=this.dataSource.MaxRowsCount;++e)this.dataSource.selection.set(e,!0);this.index=e.index(),this.tableId="table"+this.index,this.tableContainerId="tableContainer"+this.index,this.masterToggleCheckboxId="masterToggleCheckbox"+this.index,this.rowNumColumn=this.dataSource.columns[this.dataSource.columns.length-1].field,this.dataSource.onDataChanged(e=>{this.onDataChanged(e)}),this.dataSource.onSelectionChanged(e=>{this.onSelectionChanged(e)}),this.dataVisible.subscribe(e=>{0===e.length?this.tableContainer.style.display="none":this.tableContainer.style.display="block"}),this.dataSource&&this.dataSource.bindVariableName&&(this.showSQL=!0,this.dataSource.bindVariableName&&!this.dataSource.isImplicitRefCursor&&(this.originalQueryText=`${l.LocalizedConstants.Instance.cursorParameterDetails} - ${this.dataSource.bindVariableName}:`),this.dataSource.bindVariableName&&this.dataSource.isImplicitRefCursor&&(this.originalQueryText=`${l.LocalizedConstants.Instance.implicitResultSetDetails} - ${this.dataSource.bindVariableName}:`)),o.DataAccessService.instance.addSaveDataOutcomeHandler(this.dataSource.queryId,this.dataSource.queryResultId,this.onSaveAllResultEvent),o.DataAccessService.instance.subscribe(e=>{if(e&&this.messageHandlers.get(e.type)){const t=this.messageHandlers.get(e.type);t&&t(e)}else o.DataAccessService.instance.logError("Could not find handler for message "+JSON.stringify(e.type))}),this.setUserPreferences(),this.noData=t.computed(()=>!(this.dataSource&&this.dataSource.rows&&this.dataSource.rows()&&this.dataSource.rows().length>0),this);let a="";this.dataSource.AllRowsFetched||null==this.dataSource.MaxRowsCount||null==this.dataSource.MaxRowsCount||(a=l.LocalizedConstants.Instance.resultGridRowsLimited.replace("{0}",this.dataSource.MaxRowsCount.toString())),this.RowsLimitedText(a),this.checkIfAllRowsFetched()}setUserPreferences(){h.ApplicationData.instance.userPreferences&&h.ApplicationData.instance.userPreferences.resultsWindowProperties&&h.ApplicationData.instance.userPreferences.resultsWindowProperties.saveFormat&&this.selectedSaveFormat(h.ApplicationData.instance.userPreferences.resultsWindowProperties.saveFormat)}get showQuery(){return!!this.queryVisible().length}set showQuery(e){this.queryVisible.removeAll(),e&&this.queryVisible.push(e.toString())}get columnListForCorrelation(){return this.displayedColumns.map(e=>e.field)}get ShowQueryLabel(){return l.LocalizedConstants.Instance.showQuery}get CopyLabel(){return l.LocalizedConstants.Instance.copy}get SaveLabel(){return l.LocalizedConstants.Instance.save}get SaveAllLabel(){return l.LocalizedConstants.Instance.saveAll}get ShowDataLabel(){return l.LocalizedConstants.Instance.showDataLabel}get copyToClipBoardTooltip(){return l.LocalizedConstants.Instance.copyToClipBoardTooltip}get saveToCSVTooltip(){return l.LocalizedConstants.Instance.saveToCSVTooltip}get showHideResultsTooltip(){return l.LocalizedConstants.Instance.showHideResultsTooltip}get showHideQueryTooltip(){return l.LocalizedConstants.Instance.showHideQueryTooltip}get queryTextLabel(){return l.LocalizedConstants.Instance.queryTextLabel}get clickToViewQuery(){return l.LocalizedConstants.Instance.clickToViewQuery}get scrollTableToFetchMoreRecords(){return l.LocalizedConstants.Instance.scrollTableToFetchMoreRecords}get cancelLabel(){return l.LocalizedConstants.Instance.cancelQueryText}get selectColumnInternalName(){return"select"}get tableId(){return this.tableIdField}set tableId(e){this.tableIdField=e}get index(){return this.indexField}set index(e){this.indexField=e}get tableContainerId(){return this.tableContainerIdField}set tableContainerId(e){this.tableContainerIdField=e}get masterToggleCheckboxId(){return this.masterToggleCheckboxIdField}set masterToggleCheckboxId(e){this.masterToggleCheckboxIdField=e}get includeHeader(){return this.includeHeaderField}set includeHeader(e){this.includeHeaderField=e}get includeNewLine(){return this.includeNewLineField}set includeNewLine(e){this.includeNewLineField=e}get saveAllLabel(){return l.LocalizedConstants.Instance.saveAll}get noDataLabel(){return l.LocalizedConstants.Instance.noDataLabel}get page(){return l.LocalizedConstants.Instance.page}get TotalPagesText(){return l.LocalizedConstants.Instance.of+this.pageModel.lastPageNo}get showSQL(){return this.showSQLField()}set showSQL(e){this.showSQLField(e)}onModuleReady(){a.getPageContext().getBusyContext().whenReady().then(()=>{if(this.dataTableElementRef){let e=this.dataTableElementRef.getBoundingClientRect().height+"px";e&&this.gridStyle({width:"100%",height:e}),window.scrollTo(0,document.body.scrollHeight)}o.DataAccessService.instance.logInfo("Module "+this.index+" load complete")})}setPagingControls(){this.onModuleReady(),this.pageModel=new r.PagingModel,this.pageModel.lastPageNo=Math.ceil(this.dataSource.MaxRowsCount/this.modulePageSize);var e=new r.ModulePage;e.populatePageInfo(1,this.modulePageSize,this.dataSource.MaxRowsCount,this.pageModel.lastPageNo),e.rows=this.dataSource.lastBatchItems,this.pageModel.allPages.set(1,e),this.pageModel.updateRows(e.rows),this.matDataSource=new s(this.pageModel.observablePageSource,{keyAttributes:"RowNum:"+(this.dataSource.columns.length-1)}),1==this.pageModel.lastPageNo&&(this.pageModel.isSinglePage=!0,this.pageModel.isLastPage(!0));let t=this.pageModel.lastPageNo.toString().length;this.pageModel.pageInputWidth=1==t?"2.5em":2.5+.5*(t-2)+"em",this.pageModel.pagingRangeText(e.rowRangeString)}updateCurrentPage(){var e=this.pageModel.getCurPage();this.pageModel.updateRows(e.rows),this.pageModel.pagingRangeText(e.rowRangeString),this.pageModel.isFirstPage(e.isFirstPage),this.pageModel.isLastPage(e.isLastPage),this.pageModel.inputPageNo(this.pageModel.curPageNo),o.DataAccessService.instance.logInfo("Page "+this.pageModel.curPageNo+" details updated")}setMasterCheckboxElement(e){const t=$(this.moduleView).find("#"+this.masterToggleCheckboxId).first()[0];this.masterToggleValue(e),t&&(t.checked=e)}setMasterToggle(e,t=!0){e===g.Propagate?(this.ignoreChildrenNotification=!0,t?(this.selectAll(),this.masterToggleValue(!0)):(this.unselectAll(),this.masterToggleValue(!1)),this.ignoreChildrenNotification=!1):this.ignoreChildrenNotification||(this.isAllSelected()?(this.setMasterCheckboxElement(!0),this.dataSource.defaultSelection=!0):(this.setMasterCheckboxElement(!1),this.dataSource.defaultSelection=!1))}onSelectionChanged(e){this.uiMode==c.UIDisplayMode.ShowData&&this.setMasterToggle(g.Reflect)}getshowAllSQL(){return!!this.showAllSQL().length}setshowAllSQL(e){this.showAllSQL.removeAll(),e&&this.showAllSQL.push(e.toString())}isAllSelected(){let e=0;if(this.uiMode==c.UIDisplayMode.ShowData){this.dataSource.rows().forEach(t=>{t.selected()&&(e+=1)});const t=this.dataSource.rows().length;return e===t}return null}selectAll(e){if(this.uiMode!=c.UIDisplayMode.ShowData)if(e==c.RowSelection.SelectAll){this.dataSource.defaultSelection=!0;for(var t=1;t<=this.pageModel.lastPageNo;++t)if(this.pageModel.isPageFetched(t))this.pageModel.allPages.get(t).selectAll();else{let e=r.PagingModel.getStartRowNum(t,this.modulePageSize),s=r.PagingModel.getEndRowNum(t,this.modulePageSize,this.dataSource.MaxRowsCount);for(;e<=s;)this.dataSource.selection.set(e++,!0)}}else this.pageModel.pageDataSource.forEach(e=>{e().selected(!0)});else this.dataSource.defaultSelection=!0,this.dataSource.rows().forEach(e=>{e.selected(!0)})}unselectAll(e){if(this.uiMode!=c.UIDisplayMode.ShowData)if(e==c.RowSelection.UnselectAll){this.dataSource.defaultSelection=!1;for(var t=1;t<=this.pageModel.lastPageNo;++t)if(this.pageModel.isPageFetched(t))this.pageModel.allPages.get(t).unselectAll();else{let e=r.PagingModel.getStartRowNum(t,this.modulePageSize),s=r.PagingModel.getEndRowNum(t,this.modulePageSize,this.dataSource.MaxRowsCount);for(;e<=s;)this.dataSource.selection.has(e)&&this.dataSource.selection.delete(e),e++}}else this.pageModel.pageDataSource.forEach(e=>{e().selected(!1)});else this.dataSource.defaultSelection=!1,this.dataSource.rows().forEach(e=>{e.selected(!1)})}getQueryForLabel(e){if(e.length>25){return e.substring(0,25)+"..."}return e}validateAndGotoPage(e){if(o.DataAccessService.instance.logInfo("Validating page "+e),e!=this.pageModel.curPageNo){if(e>this.pageModel.lastPageNo||e<1)return this.pageModel.setToPrevPageNo(),void o.DataAccessService.instance.logInfo("Page "+e+" out of range");this.pageModel.curPageNo=e,this.pageModel.isPageFetched()?(o.DataAccessService.instance.logInfo("Page is fetched. Updating details of page."),this.updateCurrentPage(),this.pageModel.pendingPage=0):(o.DataAccessService.instance.logInfo("Page is not fetched."),this.pageModel.pendingPage=e,this.fetchNextBatch())}}tooltipOpen(e,t,s){const a=document.getElementById("tooltip_"+e);a.setAttribute("data-hover","true"),$("#tooltip_"+e).find(".oj-popup-content").first().text(s),a.position.of={x:t.pageX,y:t.pageY},setTimeout(()=>{"true"==a.getAttribute("data-hover")&&a.open("#cellContainer_"+e)},400)}tooltipClose(e){const t=document.getElementById("tooltip_"+e);t.setAttribute("data-hover","false"),t.isOpen&&t.close()}updatePosition(e,t){document.getElementById("tooltip_"+e).position.of={x:t.pageX,y:t.pageY}}onDataChanged(e){if(this.pendingRequestCount()>0&&this.pendingRequestCount(this.pendingRequestCount()-1),this.uiMode!=c.UIDisplayMode.ShowData){let e=this.pageModel.getPageFromBatchId(this.dataSource.batchId);o.DataAccessService.instance.logInfo("Data fetched for page "+e);var t=new r.ModulePage;t.populatePageInfo(e,this.modulePageSize,this.dataSource.MaxRowsCount,this.pageModel.lastPageNo),t.rows=this.dataSource.lastBatchItems,this.pageModel.allPages.set(e,t),this.pageModel.pendingPage>0&&(o.DataAccessService.instance.logInfo("Page "+this.pageModel.pendingPage+" yet to load."),this.pageModel.isPageFetched(this.pageModel.pendingPage)?(o.DataAccessService.instance.logInfo("Updating page "+this.pageModel.pendingPage),this.updateCurrentPage(),this.pageModel.pendingPage=0):o.DataAccessService.instance.logInfo("Page "+this.pageModel.pendingPage+" is not fetched"))}}checkIfAllRowsFetched(){if(this.uiMode!==c.UIDisplayMode.ShowData){let e=this.dataSource&&this.dataSource.rows&&this.dataSource.rows()&&!this.dataSource.AllRowsFetched;this.ShowRowsLimited(e)}}selectionValid(){return this.dataSource.selection&&this.dataSource.selection.size>0}getColumnsToSave(){const e=[];return this.dataSource.columns.forEach(t=>{t.name!==c.ColumnInfo.rowNumColumnName&&t.name!==c.ColumnInfo.selectedColumnName&&e.push(t)}),e}fetchNextBatch(){if(0===this.pendingRequestCount()){const t=new c.ScriptExecutionDataBatchRequest;var e;t.batchId=++this.nextBatchId,this.uiMode==c.UIDisplayMode.ShowData?(e=d.showDataFetchSize,t.startIndex=this.dataSource.endIndex+1,t.endIndex=this.dataSource.endIndex+e,o.DataAccessService.instance.logInfo("Fetching data batch "+(this.nextBatchId+1))):(e=this.modulePageSize,t.startIndex=(this.pageModel.pendingPage-1)*this.modulePageSize+1,t.endIndex=t.startIndex-1+e,this.pageModel.batchToPageMap.set(this.nextBatchId+1,this.pageModel.pendingPage),o.DataAccessService.instance.logInfo("Fetching data for page "+this.pageModel.pendingPage)),t.queryId=this.dataSource.queryId.toString(),t.queryResultId=this.dataSource.queryResultId,t.executionId=this.dataSource.executionId,t.bindVariableId=this.dataSource.bindVariableId;try{o.DataAccessService.instance.getDataBatch(t),this.pendingRequestCount(this.pendingRequestCount()+1),o.DataAccessService.instance.logInfo("Successfully placed batch request for "+JSON.stringify(t))}catch(e){o.DataAccessService.instance.logError(e),n.MessagesService.getinstance().ShowMessage(l.LocalizedConstants.Instance.unableToFetchMoreRecords,r.Severity.error)}return!0}return!1}onScroll(e){if(this.getScrollDirection(this.previousScrollTop,e.scrollTop)===u.Down&&this.isEndOfContent(e)&&this.dataSource.hasMoreRows&&this.fetchNextBatch()){let e=this.scrollPosValue();e=e.y-this.scrollDecrement,this.scrollPosValue(e)}this.previousScrollTop=e.scrollTop}getScrollDirection(e,t){return e<t?u.Down:u.Up}isEndOfContent(e){return Math.abs(e.scrollHeight-e.scrollTop-e.clientHeight)<=3}handleTransitionCompleted(e){this.moduleView=e.element,o.DataAccessService.instance.logInfo("handleTransitionCompleted QueryResultModule"+this.index),this.moduleRenderingCompleted.dispatch(this.index),this.dataTableElementRef=$(this.moduleView).find("#"+this.tableId).first()[0],this.tableContainer=$(this.moduleView).find("#"+this.tableContainerId).first()[0],this.tableContainer&&(this.tableContainer.style.display="block"),this.isDomAvailable=!0}copyToClipBoard(e){const t=document.createElement("textarea");t.value=e,document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t)}prepareCSV(e,t){o.DataAccessService.instance.logInfo("Preparing CSV ...");const s=e;let a,i,l=",";if(2==o.DataAccessService.instance.csvDelimiter.length&&"\\"==o.DataAccessService.instance.csvDelimiter.charAt(0))try{l=decodeURI(JSON.parse('"'+o.DataAccessService.instance.csvDelimiter.replace(/\"/g,'\\"')+'"'))}catch(e){o.DataAccessService.instance.logInfo("Invalid delimiter entered. Using comma to prepare csv.")}else l=o.DataAccessService.instance.csvDelimiter;a=o.DataAccessService.instance.csvQualifier,i=""==a?e=>e:e=>a+e+a;const n=t;let r=[];r=s.map(e=>n.map(t=>{let s=(e=>null===e?"":e)(e[t.field]);return s=i(s),!this.includeNewLine&&s.replace&&(s=s.replace(/[\r\n]/gm,"")),s}).join(l)),this.includeHeader&&r.unshift(n.map(e=>e.name).join(l));const c=r.join("\r\n");return o.DataAccessService.instance.logInfo("Successfully prepared results."),c}getUserPreferences(){const e=new c.MessageBase;e.type=c.MessageName.getUserPreferencesRequest;const t=new c.GetUserPreferencesRequest;t.executionId=this.dataSource.executionId,t.ownerUri=o.DataAccessService.instance.URI,t.windowUri=o.DataAccessService.instance.windowUri,e.data=t;try{o.DataAccessService.instance.send(e),o.DataAccessService.instance.logInfo("Successfully placed GetUserPreferencesRequest")}catch(e){o.DataAccessService.instance.logError(e)}}handlegetUserPreferencesResponse(e){o.DataAccessService.instance.logInfo("Received GetUserPreferencesResponse");try{const t=e.data;if(t.result){let e=t.userPreferences;e&&e.resultsWindowProperties&&e.resultsWindowProperties.saveFormat&&this.selectedSaveFormat(e.resultsWindowProperties.saveFormat)}}catch(e){o.DataAccessService.instance.logError(e)}}}}));
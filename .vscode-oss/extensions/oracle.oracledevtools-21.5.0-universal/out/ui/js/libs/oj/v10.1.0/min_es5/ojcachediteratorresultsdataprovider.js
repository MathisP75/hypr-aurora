!function(){function t(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function e(t,e){for(var a=0;a<e.length;a++){var r=e[a];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function a(t,a,r){return a&&e(t.prototype,a),r&&e(t,r),t}
/**
 * @license
 * Copyright (c) 2014, 2021, Oracle and/or its affiliates.
 * Licensed under The Universal Permissive License (UPL), Version 1.0
 * as shown at https://oss.oracle.com/licenses/upl/
 * @ignore
 */define(["ojs/ojcore-base","ojs/ojeventtarget","ojs/ojcomponentcore","ojs/ojdataprovider"],function(e,r,s,i){"use strict";e=e&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e;
/**
   * @license
   * Copyright (c) 2014, 2021, Oracle and/or its affiliates.
   * The Universal Permissive License (UPL), Version 1.0
   * @ignore
   */
/**
   * @preserve Copyright 2013 jQuery Foundation and other contributors
   * Released under the MIT license.
   * http://jquery.org/license
   */
var n=function(){function r(s){t(this,r),this.dataProvider=s,this.CacheAsyncIterable=function(){return function e(a,r,s){var i=this;t(this,e),this._parent=a,this.dataProviderAsyncIterator=r,this.cache=s,this[Symbol.asyncIterator]=function(){return new i._parent.CacheAsyncIterator(i._parent,i.dataProviderAsyncIterator,i.cache)}}}(),this.CacheAsyncIterator=function(){function e(a,r,s){t(this,e),this._parent=a,this.asyncIterator=r,this.cache=s,this._cachedOffset=0,this._iteratedOffset=0}return a(e,[{key:"next",value:function(){var t,e=this,a=this,r=this._parent._lastFetchParams,s=r.size?r.size:-1;if(-1==s){if(this.cache.isDone())return t=this.cache.getDataList(r,this._cachedOffset),this._cachedOffset=this._cachedOffset+t.data.length,Promise.resolve(new this._parent.CacheAsyncIteratorReturnResult(t))}else{if(this.cache.getSize()>=this._cachedOffset+s||this.cache.isDone())return t=this.cache.getDataList(r,this._cachedOffset),this._cachedOffset=this._cachedOffset+t.data.length,this._cachedOffset<this.cache.getSize()||!this.cache.isDone()?Promise.resolve(new this._parent.CacheAsyncIteratorYieldResult(t)):Promise.resolve(new this._parent.CacheAsyncIteratorReturnResult(t));if(this._cachedOffset>0)return new Promise(function(t,e){if(a._iteratedOffset<a._cachedOffset){return function e(){return a.asyncIterator.next().then(function(r){if(a._iteratedOffset=a._iteratedOffset+r.value.data.length,!(a._iteratedOffset>=a._cachedOffset||r.done))return e();t()})}()}t()}).then(function(){return e.asyncIterator.next().then(function(t){return a._iteratedOffset=a._iteratedOffset+t.value.data.length,a._cachedOffset=a._iteratedOffset,a.cache.addListResult(t),t.done?new a._parent.CacheAsyncIteratorReturnResult(t.value):new a._parent.CacheAsyncIteratorYieldResult(t.value)})})}return this.asyncIterator.next().then(function(t){return a._iteratedOffset=a._iteratedOffset+t.value.data.length,a._cachedOffset=a._iteratedOffset,a.cache.addListResult(t),-1!=s||e.cache.isDone()||e.asyncIterator.next().then(function(t){a.cache.addListResult(t)}),t.done?new a._parent.CacheAsyncIteratorReturnResult(t.value):new a._parent.CacheAsyncIteratorYieldResult(t.value)})}}]),e}(),this.CacheAsyncIteratorYieldResult=function(){return function e(a){t(this,e),this.value=a,this[r._VALUE]=a,this[r._DONE]=!1}}(),this.CacheAsyncIteratorReturnResult=function(){return function e(a){t(this,e),this.value=a,this[r._VALUE]=a,this[r._DONE]=!0}}();var i=this;this.cache=new e.DataCache,this._lastFetchParams=null,s.createOptimizedKeyMap&&(this.createOptimizedKeyMap=function(t){return s.createOptimizedKeyMap(t)}),s.createOptimizedKeySet&&(this.createOptimizedKeySet=function(t){return s.createOptimizedKeySet(t)}),s.addEventListener(r._MUTATE,function(t){i.cache.processMutations(t.detail),i.dispatchEvent(t)}),s.addEventListener(r._REFRESH,function(t){i.cache.reset(),i.dispatchEvent(t)})}return a(r,[{key:"containsKeys",value:function(t){var e=new Set,a=new Set,r=this.cache.getDataByKeys(t);if(t.keys.forEach(function(t){r.results.get(t)?e.add(t):a.add(t)}),0==a.size)return Promise.resolve({containsParameters:t,results:e});var s={attributes:t.attributes,keys:a,scope:t.scope};return this.dataProvider.containsKeys(s).then(function(a){return a.results.forEach(function(t){e.add(t)}),{containsParameters:t,results:e}})}},{key:"fetchByKeys",value:function(t){var e=new Map,a=new Set,r=this.cache.getDataByKeys(t);if(t.keys.forEach(function(t){var s=r.results.get(t);s?e.set(t,s):a.add(t)}),0==a.size)return Promise.resolve({fetchParameters:t,results:e});var s={attributes:t.attributes,keys:a,scope:t.scope};return this.dataProvider.fetchByKeys(s).then(function(a){return a.results.forEach(function(t,a){e.set(a,t)}),{fetchParameters:t,results:e}})}},{key:"fetchByOffset",value:function(t){var e=t.size?t.size:r._DEFAULT_SIZE;if(this._compareLastFetchParameters(t)&&t.offset+e<=this.cache.getSize()){var a=JSON.parse(JSON.stringify(t));a.size=e;var s=this.cache.getDataByOffset(a);if(s)return Promise.resolve(s)}return this.dataProvider.fetchByOffset(t)}},{key:"fetchFirst",value:function(t){this._compareLastFetchParameters(t)||this.cache.reset(),this._storeLastFetchParams(t);var e=this.dataProvider.fetchFirst(t);return new this.CacheAsyncIterable(this,e[Symbol.asyncIterator](),this.cache)}},{key:"getCapability",value:function(t){var e=this.dataProvider.getCapability(t);return"fetchCapability"===t?{attributeFilter:null==e?void 0:e.attributeFilter,caching:"visitedByCurrentIterator"}:e}},{key:"getTotalSize",value:function(){return!this._lastFetchParams.filterDef&&this.cache.isDone()?Promise.resolve(this.cache.getSize()):this.dataProvider.getTotalSize()}},{key:"isEmpty",value:function(){return!this._lastFetchParams.filterDef&&this.cache.isDone()?0===this.cache.getSize()?"yes":"no":this.dataProvider.isEmpty()}},{key:"_compareLastFetchParameters",value:function(t){return t=t||{},null!=this._lastFetchParams&&e.Object.compareValues(this._lastFetchParams.attributes,t.attributes||null)&&e.Object.compareValues(this._lastFetchParams.filterDef,this._getFilterDef(t.filterCriterion))&&e.Object.compareValues(this._lastFetchParams.sortCriteria,t.sortCriteria||null)}},{key:"_storeLastFetchParams",value:function(t){t=t||{},this._lastFetchParams={},this._lastFetchParams.size=t.size,this._lastFetchParams.attributes=t.attributes?JSON.parse(JSON.stringify(t.attributes)):null,this._lastFetchParams.filterDef=this._getFilterDef(t.filterCriterion),this._lastFetchParams.sortCriteria=t.sortCriteria?JSON.parse(JSON.stringify(t.sortCriteria)):null}},{key:"_getFilterDef",value:function(t){if(!t)return null;var e={};return Object.keys(t).forEach(function(a){"filter"!=a&&(e[a]=t[a])}),e}}]),r}();return n._KEY="key",n._KEYS="keys",n._DATA="data",n._STARTINDEX="startIndex",n._SORT="sort",n._SORTCRITERIA="sortCriteria",n._FILTERCRITERION="filterCriterion",n._METADATA="metadata",n._ITEMS="items",n._FROM="from",n._OFFSET="offset",n._REFRESH="refresh",n._MUTATE="mutate",n._SIZE="size",n._FETCHPARAMETERS="fetchParameters",n._VALUE="value",n._DONE="done",n._RESULTS="results",n._CONTAINSPARAMETERS="containsParameters",n._DEFAULT_SIZE=25,n._CONTAINSKEYS="containsKeys",n._FETCHBYKEYS="fetchByKeys",n._FETCHBYOFFSET="fetchByOffset",n._FETCHFIRST="fetchFirst",n._ADDEVENTLISTENER="addEventListener",n._FETCHATTRIBUTES="attributes",r.EventTargetMixin.applyMixin(n),e._registerLegacyNamespaceProp("CachedIteratorResultsDataProvider",n),n})}();
//# sourceMappingURL=ojcachediteratorresultsdataprovider.js.map
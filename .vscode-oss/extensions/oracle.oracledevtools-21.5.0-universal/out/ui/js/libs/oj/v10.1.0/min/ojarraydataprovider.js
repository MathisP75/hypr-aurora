/**
 * @license
 * Copyright (c) 2014, 2021, Oracle and/or its affiliates.
 * Licensed under The Universal Permissive License (UPL), Version 1.0
 * as shown at https://oss.oracle.com/licenses/upl/
 * @ignore
 */
define(["ojs/ojcore-base","ojs/ojmap","ojs/ojset","ojs/ojdataprovider","ojs/ojeventtarget","ojs/ojlogger"],function(t,e,i,s,n,r){"use strict";t=t&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t,e=e&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e,i=i&&Object.prototype.hasOwnProperty.call(i,"default")?i.default:i;
/**
     * @license
     * Copyright (c) 2014, 2021, Oracle and/or its affiliates.
     * The Universal Permissive License (UPL), Version 1.0
     * as shown at https://oss.oracle.com/licenses/upl/
     * @ignore
     */
/**
     * @preserve Copyright 2013 jQuery Foundation and other contributors
     * Released under the MIT license.
     * http://jquery.org/license
     */
class a{constructor(t,e){this.data=t,this.options=e,this.Item=class{constructor(t,e){this.metadata=t,this.data=e,this[a._METADATA]=t,this[a._DATA]=e}},this.ItemMetadata=class{constructor(t){this.key=t,this[a._KEY]=t}},this.FetchByKeysResults=class{constructor(t,e){this.fetchParameters=t,this.results=e,this[a._FETCHPARAMETERS]=t,this[a._RESULTS]=e}},this.ContainsKeysResults=class{constructor(t,e){this.containsParameters=t,this.results=e,this[a._CONTAINSPARAMETERS]=t,this[a._RESULTS]=e}},this.FetchByOffsetResults=class{constructor(t,e,i){this.fetchParameters=t,this.results=e,this.done=i,this[a._FETCHPARAMETERS]=t,this[a._RESULTS]=e,this[a._DONE]=i}},this.FetchListParameters=class{constructor(t,e,i,s){this.size=t,this.sortCriteria=e,this.filterCriterion=i,this.attributes=s,this[a._SIZE]=t,this[a._SORTCRITERIA]=e,this[a._FILTERCRITERION]=i,this[a._ATTRIBUTES]=s}},this.FetchListResult=class{constructor(t,e,i){this.fetchParameters=t,this.data=e,this.metadata=i,this[a._FETCHPARAMETERS]=t,this[a._DATA]=e,this[a._METADATA]=i}},this.AsyncIterable=class{constructor(t){this._asyncIterator=t,this[Symbol.asyncIterator]=function(){return this._asyncIterator}}},this.AsyncIterator=class{constructor(t,e,i,s){this._parent=t,this._nextFunc=e,this._params=i,this._offset=s,this._clientId=i&&i.clientId||Symbol(),t._mapClientIdToOffset.set(this._clientId,s),this._cacheObj={},this._cacheObj[a._MUTATIONSEQUENCENUM]=t._mutationSequenceNum}next(){const t=this._parent._mapClientIdToOffset.get(this._clientId);let e=this._nextFunc(this._params,t,!1,this._cacheObj);return this._parent._mapClientIdToOffset.set(this._clientId,e.offset),Promise.resolve(e.result)}},this.AsyncIteratorYieldResult=class{constructor(t){this.value=t,this[a._VALUE]=t,this[a._DONE]=!1}},this.AsyncIteratorReturnResult=class{constructor(t){this.value=t,this[a._VALUE]=t,this[a._DONE]=!0}},this.DataProviderMutationEventDetail=class{constructor(t,e,i,s){this._parent=t,this.add=e,this.remove=i,this.update=s,this[a._ADD]=e,this[a._REMOVE]=i,this[a._UPDATE]=s,Object.defineProperty(this,a._PARENT,{value:t,enumerable:!1})}},this.DataProviderOperationEventDetail=class{constructor(t,e,i,s,n){this._parent=t,this.keys=e,this.metadata=i,this.data=s,this.indexes=n,this[a._KEYS]=e,this[a._METADATA]=i,this[a._DATA]=s,this[a._INDEXES]=n,Object.defineProperty(this,a._PARENT,{value:t,enumerable:!1})}},this.DataProviderAddOperationEventDetail=class{constructor(t,e,i,s,n,r,l){this._parent=t,this.keys=e,this.afterKeys=i,this.addBeforeKeys=s,this.metadata=n,this.data=r,this.indexes=l,this[a._KEYS]=e,this[a._AFTERKEYS]=i,this[a._ADDBEFOREKEYS]=s,this[a._METADATA]=n,this[a._DATA]=r,this[a._INDEXES]=l,Object.defineProperty(this,a._PARENT,{value:t,enumerable:!1})}},this._cachedIndexMap=[],this._sequenceNum=0,this._mutationSequenceNum=0,this._mapClientIdToOffset=new Map,this._subscribeObservableArray(t),null!=e&&null!=e[a._KEYS]&&(this._keysSpecified=!0,this._keys=e[a._KEYS])}containsKeys(t){let e=this;return this.fetchByKeys(t).then(function(s){let n=new i;return t[a._KEYS].forEach(function(t){null!=s[a._RESULTS].get(t)&&n.add(t)}),Promise.resolve(new e.ContainsKeysResults(t,n))})}fetchByKeys(i){let s=this;this._generateKeysIfNeeded();let n,r=new e,l=this._getKeys(),o=null!=i?i[a._ATTRIBUTES]:null,u=0;if(i){let e=s._getRowData();return i[a._KEYS].forEach(function(i){for(n=null,u=0;u<l.length;u++)if(t.Object.compareValues(l[u],i)){n=u;break}if(null!=n&&n>=0){let t=e[n];if(o&&o.length>0){let e={};s._filterRowAttributes(o,t,e),t=e}r.set(i,new s.Item(new s.ItemMetadata(i),t))}}),Promise.resolve(new s.FetchByKeysResults(i,r))}return Promise.reject("Keys are a required parameter")}fetchByOffset(t){let e=this,i=null!=t?t[a._SIZE]:-1,s=null!=t?t[a._SORTCRITERIA]:null,n=null!=t&&t[a._OFFSET]>0?t[a._OFFSET]:0,r=null!=t?t[a._ATTRIBUTES]:null,l=null!=t?t[a._FILTERCRITERION]:null;this._generateKeysIfNeeded();let o=[],u=!0;if(t){let h=new this.FetchListParameters(i,s,l,r),_=this._fetchFrom(h,n,!0).result,c=_[a._VALUE];u=_[a._DONE];let f=c[a._DATA],d=c[a._METADATA].map(function(t){return t[a._KEY]});return o=f.map(function(t,i){return new e.Item(new e.ItemMetadata(d[i]),t)}),Promise.resolve(new this.FetchByOffsetResults(t,o,u))}return Promise.reject("Offset is a required parameter")}fetchFirst(t){return new this.AsyncIterable(new this.AsyncIterator(this,this._fetchFrom.bind(this),t,0))}getCapability(t){return a.getCapability(t)}static _getFetchCapability(){let t=new Set;return t.add("exclusion"),{caching:"all",attributeFilter:{expansion:{},ordering:{},defaultShape:{features:t}}}}static getCapability(t){return"sort"==t?{attributes:"multiple"}:"fetchByKeys"==t?Object.assign({implementation:"lookup"},a._getFetchCapability()):"fetchByOffset"==t?Object.assign({implementation:"randomAccess"},a._getFetchCapability()):"fetchFirst"==t?Object.assign({iterationSpeed:"immediate"},a._getFetchCapability()):"fetchCapability"==t?a._getFetchCapability():"filter"==t?{operators:["$co","$eq","$ew","$pr","$gt","$ge","$lt","$le","$ne","$regex","$sw"],attributeExpression:["*"],textFilter:{}}:null}getTotalSize(){return Promise.resolve(this._getRowData().length)}isEmpty(){return this._getRowData().length>0?"no":"yes"}createOptimizedKeySet(t){return new i(t)}createOptimizedKeyMap(t){if(t){let i=new e;return t.forEach(function(t,e){i.set(e,t)}),i}return new e}_getRowData(){return this[a._DATA]instanceof Array?this[a._DATA]:this[a._DATA]()}_getKeys(){return null==this._keys||this._keys instanceof Array?this._keys:this._keys()}_indexOfKey(e){let i,s=this._getKeys(),n=-1;for(i=0;i<s.length;i++)if(t.Object.compareValues(s[i],e)){n=i;break}return n}_adjustIteratorOffset(t,e){this._mapClientIdToOffset.forEach((i,s)=>{let n=0;t&&t.forEach(function(t){t<i&&++n}),i-=n,e&&e.forEach(function(t){t<i&&++i}),this._mapClientIdToOffset.set(s,i)})}_subscribeObservableArray(e){if(!(e instanceof Array)){if(!this._isObservableArray(e))throw new Error("Invalid data type. ArrayDataProvider only supports Array or observableArray.");let n=this;e.subscribe(function(e){let s,a,l,o,u,h=[],_=[],c=[],f=[],d=[];n._mutationSequenceNum++;let E=!0,p=!0;e.forEach(function(t){"deleted"===t.status?(E=!1):"added"===t.status&&(p=!1)});let T=[],A=[],m=null,y=null,R=null,I=n._generateKeysIfNeeded();if(!E&&!p){for(s=0;s<e.length;s++){o=e[s].index,u=e[s].status;let i=n._getId(e[s].value);for(a=0;a<e.length;a++)a!=s&&o===e[a].index&&u!==e[a].status&&T.indexOf(s)<0&&A.indexOf(s)<0&&(null==i||t.Object.compareValues(i,n._getId(e[a].value)))&&("deleted"===u?(A.push(s),T.push(a)):(A.push(a),T.push(s)))}for(s=0;s<e.length;s++)if(T.indexOf(s)>=0){let t=n._getKeys()[e[s].index];_.push(t),h.push(e[s].value),c.push(e[s].index)}if(_.length>0){f=_.map(function(t){return new n.ItemMetadata(t)});let t=new i;_.map(function(e){t.add(e)}),m=new n.DataProviderOperationEventDetail(n,t,f,h,c)}}if(h=[],_=[],c=[],!E){for(s=0;s<e.length;s++)"deleted"===e[s].status&&T.indexOf(s)<0&&A.indexOf(s)<0&&(l=n._getId(e[s].value),null==l&&(l=I?e[s].index:n._getKeys()[e[s].index]),_.push(l),h.push(e[s].value),c.push(e[s].index));if(_.length>0&&_.map(function(t){let e=n._indexOfKey(t);e>=0&&n._keys.splice(e,1)}),_.length>0){f=_.map(function(t){return new n.ItemMetadata(t)});let t=new i;_.map(function(e){t.add(e)}),R=new n.DataProviderOperationEventDetail(n,t,f,h,c)}}if(h=[],_=[],c=[],!p){let t=null==n._getKeys()||!(n._getKeys().length>0);for(s=0;s<e.length;s++)"added"===e[s].status&&T.indexOf(s)<0&&A.indexOf(s)<0&&(l=n._getId(e[s].value),null==l&&(I||n._keysSpecified)&&(l=n._getKeys()[e[s].index]),null==l?(l=n._sequenceNum++,n._keys.splice(e[s].index,0,l)):t||-1===n._indexOfKey(l)?n._keys.splice(e[s].index,0,l):I||n._keysSpecified||(r.warn("added row has duplicate key "+l),n._keys.splice(e[s].index,0,l)),_.push(l),h.push(e[s].value),c.push(e[s].index));for(s=0;s<e.length;s++)if("added"===e[s].status&&T.indexOf(s)<0&&A.indexOf(s)<0){let t=n._getKeys()[e[s].index+1];t=null==t?null:t,d.push(t)}if(_.length>0){f=_.map(function(t){return new n.ItemMetadata(t)});let t=new i;_.map(function(e){t.add(e)});let e=new i;d.map(function(t){e.add(t)}),y=new n.DataProviderAddOperationEventDetail(n,t,e,d,f,h,c)}}n._fireMutationEvent(y,R,m)},null,"arrayChange"),e.subscribe(function(t){var e,i,r,a;if(n._mutationEvent){const t=n._mutationEvent.detail;n._adjustIteratorOffset(null===(e=t.remove)||void 0===e?void 0:e.indexes,null===(i=t.add)||void 0===i?void 0:i.indexes),n.dispatchEvent(n._mutationEvent)}else if(n._mutationRemoveEvent||n._mutationAddEvent||n._mutationUpdateEvent){if(n._mutationRemoveEvent){const t=n._mutationRemoveEvent.detail;n._adjustIteratorOffset(null===(r=t.remove)||void 0===r?void 0:r.indexes,null),n.dispatchEvent(n._mutationRemoveEvent)}if(n._mutationAddEvent){const t=n._mutationAddEvent.detail;n._adjustIteratorOffset(null,null===(a=t.add)||void 0===a?void 0:a.indexes),n.dispatchEvent(n._mutationAddEvent)}n._mutationUpdateEvent&&n.dispatchEvent(n._mutationUpdateEvent)}else n.dispatchEvent(new s.DataProviderRefreshEvent);n._mutationEvent=null,n._mutationRemoveEvent=null,n._mutationAddEvent=null,n._mutationUpdateEvent=null},null,"change")}}_fireMutationEvent(t,e,i){let n=new this.DataProviderMutationEventDetail(this,t,e,i);this._mutationEvent=new s.DataProviderMutationEvent(n)}_hasSamePropValue(e,i,s){const n="_hasSamePropValue is true";try{e&&e[s]&&e[s].forEach(function(e){i&&i[s]&&i[s].forEach(function(i){if(t.Object.compareValues(e,i))throw n})})}catch(t){if(t===n)return!0;throw t}return!1}_isObservableArray(t){return"function"==typeof t&&t.subscribe&&!(void 0===t.destroyAll)}_generateKeysIfNeeded(){if(null==this._keys){let t=null!=this.options?this.options[a._KEYATTRIBUTES]||this.options[a._IDATTRIBUTE]:null;this._keys=[];let e,i=this._getRowData(),s=0;for(s=0;s<i.length;s++)e=this._getId(i[s]),null!=e&&"@index"!=t||(e=this._sequenceNum++),this._keys[s]=e;return!0}return!1}_getId(t){let e,i=null;if(null!=this.options&&(null!=this.options[a._KEYATTRIBUTES]?i=this.options[a._KEYATTRIBUTES]:null!=this.options[a._IDATTRIBUTE]&&(i=this.options[a._IDATTRIBUTE])),null!=i){if(Array.isArray(i)){let s;for(e=[],s=0;s<i.length;s++)e[s]=this._getVal(t,i[s])}else e="@value"==i?this._getAllVals(t):this._getVal(t,i);return e}return null}_getVal(t,e){if("string"==typeof e){let i=e.indexOf(".");if(i>0){let s=e.substring(0,i),n=e.substring(i+1),r=t[s];if(r)return this._getVal(r,n)}}return"function"==typeof t[e]?t[e]():t[e]}_getAllVals(t){let e=this;return Object.keys(t).map(function(i){return e._getVal(t,i)})}_fetchFrom(t,e,i,n){let r=this,l=null!=t?t[a._ATTRIBUTES]:null;this._generateKeysIfNeeded();let o=null!=t?t[a._SORTCRITERIA]:null,u=this._getCachedIndexMap(o,n),h=this._getRowData(),_=u.map(function(t){return h[t]}),c=u.map(function(t){return r._getKeys()[t]}),f=null!=t?t[a._SIZE]>0?t[a._SIZE]:t[a._SIZE]<0?r._getKeys().length:25:25,d=e+f<_.length,E=this._mergeSortCriteria(o);null!=E&&((t=t||{})[a._SORTCRITERIA]=E);let p,T=[],A=[],m=0;if(null!=t&&t[a._FILTERCRITERION]){let i=null;i=s.FilterFactory.getFilter({filterDef:t[a._FILTERCRITERION],filterOptions:this.options});let n=0;for(;T.length<f&&n<_.length;)i.filter(_[n])&&(m>=e&&(T.push(_[n]),A.push(c[n])),m++),n++;d=n<_.length}else T=_.slice(e,e+f),A=c.slice(e,e+f);m=e+T.length,p=T.map(function(t){if(l&&l.length>0){let e={};r._filterRowAttributes(l,t,e),t=e}return t});let y=A.map(function(t){return new r.ItemMetadata(t)}),R=new this.FetchListResult(t,p,y);return(i?d:R.data.length>0)?{result:new this.AsyncIteratorYieldResult(R),offset:m}:{result:new this.AsyncIteratorReturnResult(R),offset:m}}_getCachedIndexMap(t,e){if(e&&e.indexMap&&e[a._MUTATIONSEQUENCENUM]===this._mutationSequenceNum)return e.indexMap;let i=this._getRowData().map(function(t,e){return e}),s=this._sortData(i,t);return e&&(e.indexMap=s,e[a._MUTATIONSEQUENCENUM]=this._mutationSequenceNum),s}_sortData(t,e){let i=this._getRowData(),s=t.map(function(t){return{index:t,value:i[t]}});return null!=e&&s.sort(this._getSortComparator(e)),s.map(function(t){return t.index})}_getSortComparator(t){let e=this;return function(i,s){let n,r,l,o,u,h,_=null!=e.options?e.options[a._SORTCOMPARATORS]:null;for(n=0;n<t.length;n++)if(r=t[n][a._DIRECTION],l=t[n][a._ATTRIBUTE],o=null,null!=_&&(o=_[a._COMPARATORS].get(l)),u=e._getVal(i.value,l),h=e._getVal(s.value,l),null!=o){let t="descending"==r?-1:1,e=o(u,h)*t;if(0!=e)return e}else{let t=0,e="string"==typeof u?u:new String(u).toString(),i="string"==typeof h?h:new String(h).toString();if(t="ascending"==r?e.localeCompare(i,void 0,{numeric:!0,sensitivity:"base"}):i.localeCompare(e,void 0,{numeric:!0,sensitivity:"base"}),0!=t)return t}return 0}}_mergeSortCriteria(t){let e=null!=this.options?this.options[a._IMPLICITSORT]:null;if(null!=e){if(null==t)return e;let i,s,n,r=t.slice(0);for(i=0;i<e.length;i++){for(n=!1,s=0;s<r.length;s++)r[s][a._ATTRIBUTE]==e[i][a._ATTRIBUTE]&&(n=!0);n||r.push(e[i])}return r}return t}_filterRowAttributes(t,e,i){let s=this;if(Array.isArray(t)){let n,r=!1;t.forEach(function(t){t!=a._ATDEFAULT&&t.name!=a._ATDEFAULT||(r=!0)}),Object.keys(e).forEach(function(a){if(r){let r,l=!1,o=a;for(n=0;n<t.length;n++)if(r=t[n]instanceof Object?t[n].name:t[n],r.startsWith("!")){if(r=r.substr(1,r.length-1),r==a){l=!0;break}}else if(r==a){o=t[n];break}l||s._filterRowAttributes(o,e,i)}else t.forEach(function(t){let n;n=t instanceof Object?t.name:t,n.startsWith("!")||n!=a||s._filterRowAttributes(t,e,i)})})}else if(t instanceof Object){let n=t.name,r=t.attributes;if(n&&!n.startsWith("!"))if(e[n]instanceof Object&&!Array.isArray(e[n])&&r){let t={};s._filterRowAttributes(r,e[n],t),i[n]=t}else if(Array.isArray(e[n])&&r){let t;i[n]=[],e[n].forEach(function(e,a){t={},s._filterRowAttributes(r,e,t),i[n][a]=t})}else s._proxyAttribute(i,e,n)}else s._proxyAttribute(i,e,t)}_proxyAttribute(t,e,i){t&&e&&Object.defineProperty(t,i,{get:function(){return e[i]},set:function(t){e[i]=t},enumerable:!0})}}return a._KEY="key",a._KEYS="keys",a._AFTERKEYS="afterKeys",a._ADDBEFOREKEYS="addBeforeKeys",a._DIRECTION="direction",a._ATTRIBUTE="attribute",a._ATTRIBUTES="attributes",a._SORT="sort",a._SORTCRITERIA="sortCriteria",a._FILTERCRITERION="filterCriterion",a._DATA="data",a._METADATA="metadata",a._INDEXES="indexes",a._OFFSET="offset",a._SIZE="size",a._IDATTRIBUTE="idAttribute",a._IMPLICITSORT="implicitSort",a._KEYATTRIBUTES="keyAttributes",a._SORTCOMPARATORS="sortComparators",a._COMPARATORS="comparators",a._COMPARATOR="comparator",a._RESULTS="results",a._CONTAINS="contains",a._FETCHPARAMETERS="fetchParameters",a._CONTAINSPARAMETERS="containsParameters",a._VALUE="value",a._DONE="done",a._ADD="add",a._REMOVE="remove",a._UPDATE="update",a._DETAIL="detail",a._FETCHLISTRESULT="fetchListResult",a._ATDEFAULT="@default",a._MUTATIONSEQUENCENUM="mutationSequenceNum",a._PARENT="_parent",n.EventTargetMixin.applyMixin(a),t._registerLegacyNamespaceProp("ArrayDataProvider",a),a});
//# sourceMappingURL=ojarraydataprovider.js.map
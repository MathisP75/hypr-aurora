!function(){function t(e){return(t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(e)}function e(t,a){return(e=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,a)}function a(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(t){return!1}}();return function(){var a,n=i(t);if(e){var s=i(this).constructor;a=Reflect.construct(n,arguments,s)}else a=n.apply(this,arguments);return r(this,a)}}function r(e,a){return!a||"object"!==t(a)&&"function"!=typeof a?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(e):a}function i(t){return(i=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function n(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function s(t,e){for(var a=0;a<e.length;a++){var r=e[a];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function o(t,e,a){return e&&s(t.prototype,e),a&&s(t,a),t}
/**
 * @license
 * Copyright (c) 2014, 2021, Oracle and/or its affiliates.
 * Licensed under The Universal Permissive License (UPL), Version 1.0
 * as shown at https://oss.oracle.com/licenses/upl/
 * @ignore
 */define(["ojs/ojcore-base","ojs/ojdataprovider","ojs/ojeventtarget","ojs/ojmap","ojs/ojset","ojs/ojcomponentcore"],function(t,r,i,s,u,d){"use strict";t=t&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t,s=s&&Object.prototype.hasOwnProperty.call(s,"default")?s.default:s,u=u&&Object.prototype.hasOwnProperty.call(u,"default")?u.default:u;
/**
   * @license
   * Copyright (c) 2014, 2021, Oracle and/or its affiliates.
   * The Universal Permissive License (UPL), Version 1.0
   * as shown at https://oss.oracle.com/licenses/upl/
   * @ignore
   */
/**
   * @preserve Copyright 2013 jQuery Foundation and other contributors
   * Released under the MIT license.
   * http://jquery.org/license
   */
/**
   * @license
   * Copyright (c) 2014, 2021, Oracle and/or its affiliates.
   * The Universal Permissive License (UPL), Version 1.0
   * as shown at https://oss.oracle.com/licenses/upl/
   * @ignore
   */
/**
   * @preserve Copyright 2013 jQuery Foundation and other contributors
   * Released under the MIT license.
   * http://jquery.org/license
   */
var f=function(){function e(){n(this,e),this.unsubmittedItems=new s,this.submittingItems=new s}return o(e,[{key:"addItem",value:function(e){var a=this.unsubmittedItems.get(e.metadata.key),r=this.submittingItems.get(e.metadata.key);if(a&&("add"===a.operation||"update"===a.operation)||r&&("add"===r.operation||"update"===r.operation))throw new Error("Cannot add item with same key as an item being added or updated");a&&"remove"===a.operation?a.item.data&&t.Object.compareValues(a.item.data,e.data)?this.unsubmittedItems.delete(e.metadata.key):this.unsubmittedItems.set(e.metadata.key,{operation:"update",item:e}):this.unsubmittedItems.set(e.metadata.key,{operation:"add",item:e})}},{key:"removeItem",value:function(t){var e=this.unsubmittedItems.get(t.metadata.key),a=this.submittingItems.get(t.metadata.key);if(e&&"remove"===e.operation||a&&"remove"===a.operation)throw new Error("Cannot remove item with same key as an item being removed");e&&"add"===e.operation?this.unsubmittedItems.delete(t.metadata.key):(e&&e.operation,this.unsubmittedItems.set(t.metadata.key,{operation:"remove",item:t}))}},{key:"updateItem",value:function(t){var e=this.unsubmittedItems.get(t.metadata.key),a=this.submittingItems.get(t.metadata.key);if(e&&"remove"===e.operation||a&&"remove"===a.operation)throw new Error("Cannot update item with same key as an item being removed");!e||"add"!==e.operation&&"update"!==e.operation?this.unsubmittedItems.set(t.metadata.key,{operation:"update",item:t}):this.unsubmittedItems.set(t.metadata.key,{operation:e.operation,item:t})}},{key:"setItemStatus",value:function(t,e,a){var r=t.item.metadata.key;if("submitting"===e)this.unsubmittedItems.delete(r),this.submittingItems.set(r,t);else if("submitted"===e)this.submittingItems.delete(r);else if("unsubmitted"===e){var i;this.submittingItems.delete(r),i=a?{operation:t.operation,item:{data:t.item.data,metadata:{key:t.item.metadata.key,message:a}}}:t,this.unsubmittedItems.set(r,i)}}},{key:"getUnsubmittedItems",value:function(){return this.unsubmittedItems}},{key:"getSubmittingItems",value:function(){return this.submittingItems}},{key:"isEmpty",value:function(){return 0===this.unsubmittedItems.size&&0===this.submittingItems.size}},{key:"getItem",value:function(t){var e=this.unsubmittedItems.get(t);return e||(e=this.submittingItems.get(t)),e}}]),e}(),m=function(t){!function(t,a){if("function"!=typeof a&&null!==a)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(a&&a.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),a&&e(t,a)}(i,t);var r=a(i);function i(t){n(this,i);var e={};return e.detail=t,r.call(this,"submittableChange",e)}return i}(t.GenericEvent),h=function(){function e(t,a){n(this,e),this.dataProvider=t,this.options=a,this.AsyncIterable=function(){return function t(e,a){n(this,t),this._parent=e,this._asyncIterator=a,this[Symbol.asyncIterator]=function(){return this._asyncIterator}}}(),this.AsyncIterator=function(){function t(e,a,r){n(this,t),this._parent=e,this._baseIterator=a,this._params=r,this.firstBaseKey=null,this.mergedAddKeySet=new u,this.mergedItemArray=[],this.nextOffset=0,null==this._params&&(this._params={})}return o(t,[{key:"_fetchNext",value:function(){var t=this;return this._baseIterator.next().then(function(e){!t.firstBaseKey&&e.value.metadata.length&&(t.firstBaseKey=e.value.metadata[0].key),e.value.fetchParameters&&e.value.fetchParameters.sortCriteria&&(t._parent.lastSortCriteria=e.value.fetchParameters.sortCriteria);var a=e.value.data.map(function(t,a){return{data:e.value.data[a],metadata:e.value.metadata[a]}});t._parent._mergeEdits(a,t.mergedItemArray,t._params.filterCriterion,t._parent.lastSortCriteria,!0,t.mergedAddKeySet,e.done);for(var r=t.mergedItemArray.length-t.nextOffset,i=t.nextOffset;i<t.mergedItemArray.length;i++){var n=t.mergedItemArray[i];t._parent._isItemRemoved(n.metadata.key)&&--r}var s=t._params||{};if((s.size&&r<s.size||null==s.size&&0===r)&&!e.done)return t._fetchNext();var o,u=[],d=[];for(o=t.nextOffset;o<t.mergedItemArray.length;o++){++t.nextOffset;var f=t.mergedItemArray[o];if(!t._parent._isItemRemoved(f.metadata.key)&&(u.push(f.data),d.push(f.metadata),s.size&&u.length===s.size))break}return{done:e.done&&0===u.length,value:{fetchParameters:t._params,data:u,metadata:d}}})}},{key:"next",value:function(){return this._fetchNext()}}]),t}(),this._addEventListeners(t),this.editBuffer=new f,this.lastSortCriteria=null,this.lastIterator=null}return o(e,[{key:"_fetchByKeysFromBuffer",value:function(t){var e=this,a=new s,r=new u;return t.keys.forEach(function(t){var i=e.editBuffer.getItem(t);if(i)switch(i.operation){case"add":case"update":a.set(t,i.item)}else r.add(t)}),{results:a,unresolvedKeys:r}}},{key:"_compareItem",value:function(t,e,a){for(var r=0;r<a.length;r++){if(t[a[r].attribute]>e[a[r].attribute])return"ascending"===a[r].direction?1:-1;if(t[a[r].attribute]<e[a[r].attribute])return"ascending"===a[r].direction?-1:1}return 0}},{key:"_insertAddEdits",value:function(t,e,a,r,i,n){var s=this;t.forEach(function(t,o){if("add"===t.operation&&!i.has(o)&&(!e||e.filter(t.item.data)))if(a&&a.length){for(var u=!1,d=0;d<r.length;d++)if(s._compareItem(t.item.data,r[d].data,a)<0){r.splice(d,0,t.item),i.add(o),u=!0;break}!u&&n&&(r.push(t.item),i.add(o))}else r.push(t.item),i.add(o)})}},{key:"_mergeAddEdits",value:function(t,e,a,r,i){this._insertAddEdits(this.editBuffer.getUnsubmittedItems(),t,e,a,r,i),this._insertAddEdits(this.editBuffer.getSubmittingItems(),t,e,a,r,i)}},{key:"_mergeEdits",value:function(t,e,a,i,n,s,o){var u;a&&(u=a.filter?a:r.FilterFactory.getFilter({filterDef:a,filterOptions:this.options})),!n||i&&i.length||this._mergeAddEdits(u,i,e,s,o);for(var d=0;d<t.length;d++){var f=t[d],m=this.editBuffer.getItem(f.metadata.key);m?"remove"===m.operation?e.push(f):"update"===m.operation&&(u&&!u.filter(m.item.data)||e.push(m.item)):e.push(f)}i&&i.length&&this._mergeAddEdits(u,i,e,s,o)}},{key:"_fetchFromOffset",value:function(t,e){var a=this;return this.dataProvider.fetchByOffset(t).then(function(r){if(!a.editBuffer.isEmpty()){var i=r.results,n=null;n=r.fetchParameters&&r.fetchParameters.sortCriteria?r.fetchParameters.sortCriteria:t.sortCriteria,a._mergeEdits(i,e,t.filterCriterion,n,0===t.offset,new u,r.done);for(var s=e.length,o=0;o<e.length;o++)a._isItemRemoved(e[o].metadata.key)&&--s;if((t.size&&s<t.size||null==t.size&&0===s)&&!r.done){var d={attributes:t.attributes,clientId:t.clientId,filterCriterion:t.filterCriterion,offset:t.offset+r.results.length,size:t.size,sortCriteria:t.sortCriteria};return a._fetchFromOffset(d,e)}for(var f=0;f<e.length;f++)a._isItemRemoved(e[f].metadata.key)&&(e.splice(f,1),--f);return t.size&&e.length>t.size&&e.splice(t.size),{fetchParameters:t,results:e,done:r.done}}return r})}},{key:"containsKeys",value:function(t){var e=this._fetchByKeysFromBuffer(t),a=e.unresolvedKeys,r=new u;return e.results.forEach(function(t,e){r.add(e)}),0===a.size?Promise.resolve({containsParameters:t,results:r}):this.dataProvider.containsKeys({attributes:t.attributes,keys:a,scope:t.scope}).then(function(e){return r.size>0?(e.results.forEach(function(t,e){r.add(e)}),{containsParameters:t,results:r}):e})}},{key:"fetchByKeys",value:function(t){var e=this._fetchByKeysFromBuffer(t),a=e.unresolvedKeys,r=e.results;return 0===a.size?Promise.resolve({fetchParameters:t,results:r}):this.dataProvider.fetchByKeys({attributes:t.attributes,keys:a,scope:t.scope}).then(function(e){return r.size>0?(e.results.forEach(function(t,e){r.set(e,t)}),{fetchParameters:t,results:r}):e})}},{key:"fetchByOffset",value:function(t){return this._fetchFromOffset(t,[])}},{key:"fetchFirst",value:function(t){this.lastSortCriteria=t?t.sortCriteria:null;var e=this.dataProvider.fetchFirst(t)[Symbol.asyncIterator]();return this.lastIterator=new this.AsyncIterator(this,e,t),new this.AsyncIterable(this,this.lastIterator)}},{key:"getCapability",value:function(t){return this.dataProvider.getCapability(t)}},{key:"_calculateSizeChange",value:function(t){var e=0;return t.forEach(function(t,a){"add"===t.operation?++e:"remove"===t.operation&&--e}),e}},{key:"getTotalSize",value:function(){var t=this;return this.dataProvider.getTotalSize().then(function(e){return e>-1&&(e+=t._calculateSizeChange(t.editBuffer.getSubmittingItems()),e+=t._calculateSizeChange(t.editBuffer.getUnsubmittedItems())),e})}},{key:"isEmpty",value:function(){var t=this.editBuffer.getUnsubmittedItems(),e=this.editBuffer.getSubmittingItems();t.forEach(function(t,e){if("add"===t.operation||"update"===t.operation)return"no"}),e.forEach(function(t,e){if("add"===t.operation||"update"===t.operation)return"no"});var a=this.dataProvider.isEmpty();return"no"===a&&(t.size>0||e.size>0)?"unknown":a}},{key:"_isItemRemoved",value:function(t){var e=this.editBuffer.getItem(t);return null!=e&&"remove"===e.operation}},{key:"_addToMergedArrays",value:function(t){var e=null;if(this.lastIterator){var a=this.lastSortCriteria;if(a&&a.length){for(var r=this.lastIterator.mergedItemArray,i=0;i<r.length;i++)if(this._compareItem(t.data,r[i].data,a)<0&&!this._isItemRemoved(r[i].metadata.key)){e=r[i].metadata.key,r.splice(i,0,t),i<this.lastIterator.nextOffset&&++this.lastIterator.nextOffset;break}}else e=this.lastIterator.firstBaseKey}return e}},{key:"addItem",value:function(t){this.editBuffer.addItem(t);var e=this._addToMergedArrays(t),a={add:{data:[t.data],keys:(new u).add(t.metadata.key),metadata:[t.metadata],addBeforeKeys:[e]}},i=new r.DataProviderMutationEvent(a);this.dispatchEvent(i),this._dispatchSubmittableChangeEvent()}},{key:"_removeFromMergedArrays",value:function(e,a){if(this.lastIterator){var r=this.lastIterator.mergedItemArray,i=this.lastIterator.mergedAddKeySet,n=this._findKeyInItems(e,r);if(-1!==n&&(a||i.has(e)?(r.splice(n,1),i.delete(e),n<this.lastIterator.nextOffset&&--this.lastIterator.nextOffset):n===this.lastIterator.nextOffset-1&&--this.lastIterator.nextOffset,t.KeyUtils.equals(this.lastIterator.firstBaseKey,e)&&(this.lastIterator.firstBaseKey=null,r.length>n)))for(var s=n;s<r.length;s++){var o=r[s].metadata.key;if(!this._isItemRemoved(o)){this.lastIterator.firstBaseKey=o;break}}}}},{key:"removeItem",value:function(t){this.editBuffer.removeItem(t),this._removeFromMergedArrays(t.metadata.key,!1);var e={remove:{data:t.data?[t.data]:null,keys:(new u).add(t.metadata.key),metadata:[t.metadata]}},a=new r.DataProviderMutationEvent(e);this.dispatchEvent(a),this._dispatchSubmittableChangeEvent()}},{key:"updateItem",value:function(t){this.editBuffer.updateItem(t);var e={update:{data:[t.data],keys:(new u).add(t.metadata.key),metadata:[t.metadata]}},a=new r.DataProviderMutationEvent(e);this.dispatchEvent(a),this._dispatchSubmittableChangeEvent()}},{key:"getSubmittableItems",value:function(){var t=this.editBuffer.getUnsubmittedItems(),e=this.editBuffer.getSubmittingItems(),a=[];return t.forEach(function(t,r){e.has(r)||a.push(t)}),a}},{key:"resetAllUnsubmittedItems",value:function(){this.editBuffer.getUnsubmittedItems().clear(),this._dispatchSubmittableChangeEvent(),this.dispatchEvent(new r.DataProviderRefreshEvent)}},{key:"_addEventDetail",value:function(t,e,a,r){null==t[e]&&(t[e]="add"===e?{data:[],keys:new u,metadata:[],addBeforeKeys:[]}:{data:[],keys:new u,metadata:[]}),t[e].keys.add(a.metadata.key),t[e].data.push(a.data),t[e].metadata.push(a.metadata),"add"===e&&t[e].addBeforeKeys.push(r)}},{key:"resetUnsubmittedItem",value:function(t){var e=this,a=this.editBuffer.getUnsubmittedItems(),i=new u,n=new s,o=a.get(t);o&&(i.add(t),n.set(t,o),a.delete(t)),this._dispatchSubmittableChangeEvent(),this.dataProvider.fetchByKeys({keys:i}).then(function(t){var a,i={};n.forEach(function(r,n){if("add"===r.operation)e._removeFromMergedArrays(r.item.metadata.key,!1),e._addEventDetail(i,"remove",r.item);else if("remove"===r.operation){if(a=t.results.get(n)){var s=null;if(e.lastIterator){var o=e.lastIterator.mergedItemArray,u=e._findKeyInItems(n,o);if(-1!==u)for(var d=u+1;d<o.length;d++)if(!e._isItemRemoved(o[d].metadata.key)){s=o[d].metadata.key;break}}e._addEventDetail(i,"add",a,s)}}else(a=t.results.get(n))?e._addEventDetail(i,"update",a):e._addEventDetail(i,"remove",r.item)}),e.dispatchEvent(new r.DataProviderMutationEvent(i))})}},{key:"setItemStatus",value:function(t,e,a){t&&(this.editBuffer.setItemStatus(t,e,a),this._dispatchSubmittableChangeEvent())}},{key:"_dispatchSubmittableChangeEvent",value:function(){var t=this.getSubmittableItems(),e=new m(t);this.dispatchEvent(e)}},{key:"_findKeyInMetadata",value:function(e,a){if(a)for(var r=0;r<a.length;r++)if(t.KeyUtils.equals(e,a[r].key))return r;return-1}},{key:"_findKeyInItems",value:function(e,a){if(a)for(var r=0;r<a.length;r++)if(t.KeyUtils.equals(e,a[r].metadata.key))return r;return-1}},{key:"_initDetailProp",value:function(t,e,a,r){t[a]&&(e[a]=r)}},{key:"_pushDetailProp",value:function(t,e,a,r){t[a]&&e[a].push(t[a][r])}},{key:"_getOperationDetail",value:function(t,e){var a=this;if(t){var r={},i=this.editBuffer.getSubmittingItems(),n=this.editBuffer.getUnsubmittedItems();if(0!==i.size||0!==n.size)return r.keys=new u,this._initDetailProp(t,r,"data",[]),this._initDetailProp(t,r,"metadata",[]),this._initDetailProp(t,r,"addBeforeKeys",[]),this._initDetailProp(t,r,"parentKeys",[]),t.keys.forEach(function(s){var o=null!=i.get(s);if(!o){var u=n.get(s);o=u&&"remove"===u.operation}if(!o&&(r.keys.add(s),t.metadata)){var d=a._findKeyInMetadata(s,t.metadata);d>-1&&(a._pushDetailProp(t,r,"data",d),a._pushDetailProp(t,r,"metadata",d),a._pushDetailProp(t,r,"addBeforeKeys",d),a._pushDetailProp(t,r,"parentKeys",d))}if(e){var f=n.get(s);!f||"remove"!==f.operation&&"update"!==f.operation||n.delete(s)}}),r;this._initDetailProp(t,r,"data",t.data),this._initDetailProp(t,r,"metadata",t.metadata),this._initDetailProp(t,r,"addBeforeKeys",t.addBeforeKeys),this._initDetailProp(t,r,"parentKeys",t.parentKeys)}return t}},{key:"_handleRefreshEvent",value:function(t){var e=this,a=this.editBuffer.getUnsubmittedItems(),r=new u;a.forEach(function(t){"remove"!==t.operation&&"update"!==t.operation||r.add(t.item.metadata.key)}),r.size>0?this.dataProvider.fetchByKeys({keys:r}).then(function(i){i.results.forEach(function(t,e){r.delete(e)}),r.forEach(function(t){a.delete(t)}),e.dispatchEvent(t)}):this.dispatchEvent(t)}},{key:"_handleMutateEvent",value:function(t){var e=this;t.detail.remove&&t.detail.remove.keys.forEach(function(t){e._removeFromMergedArrays(t,!0)});var a=t.detail.add;a&&a.metadata&&a.data&&a.metadata.forEach(function(t,r){e._addToMergedArrays({metadata:a.metadata[r],data:a.data[r]})});var i={add:this._getOperationDetail(t.detail.add,!1),remove:this._getOperationDetail(t.detail.remove,!0),update:this._getOperationDetail(t.detail.update,!1)};this.dispatchEvent(new r.DataProviderMutationEvent(i))}},{key:"_addEventListeners",value:function(t){t[e._ADDEVENTLISTENER](e._REFRESH,this._handleRefreshEvent.bind(this)),t[e._ADDEVENTLISTENER](e._MUTATE,this._handleMutateEvent.bind(this))}}]),e}();return h._REFRESH="refresh",h._MUTATE="mutate",h._ADDEVENTLISTENER="addEventListener",i.EventTargetMixin.applyMixin(h),t._registerLegacyNamespaceProp("BufferingDataProvider",h),h})}();
//# sourceMappingURL=ojbufferingdataprovider.js.map
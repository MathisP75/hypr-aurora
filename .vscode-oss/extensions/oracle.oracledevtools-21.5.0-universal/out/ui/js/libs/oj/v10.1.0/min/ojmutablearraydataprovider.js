/**
 * @license
 * Copyright (c) 2014, 2021, Oracle and/or its affiliates.
 * Licensed under The Universal Permissive License (UPL), Version 1.0
 * as shown at https://oss.oracle.com/licenses/upl/
 * @ignore
 */
define(["ojs/ojcore-base","ojs/ojmap","ojs/ojset","ojs/ojdataprovider","ojs/ojeventtarget","ojs/ojlogger"],function(t,e,i,s,n,a){"use strict";t=t&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t,e=e&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e,i=i&&Object.prototype.hasOwnProperty.call(i,"default")?i.default:i;
/**
     * @license
     * Copyright (c) 2014, 2021, Oracle and/or its affiliates.
     * The Universal Permissive License (UPL), Version 1.0
     * as shown at https://oss.oracle.com/licenses/upl/
     * @ignore
     */
/**
     * @preserve Copyright 2013 jQuery Foundation and other contributors
     * Released under the MIT license.
     * http://jquery.org/license
     */
class r{constructor(t,e){this._data=t,this.options=e,this.findMovesInArrayComparison=function(t,e,i){var s,n,a,r,l;if(t.length&&e.length)for(s=n=0;(!i||s<i)&&(r=t[n]);++n){for(a=0;l=e[a];++a)if(r.value===l.value){r.moved=l.index,l.moved=r.index,e.splice(a,1),s=a=0;break}s+=a}},this.Item=class{constructor(t,e){this.metadata=t,this.data=e,this[r._METADATA]=t,this[r._DATA]=e}},this.ItemMetadata=class{constructor(t){this.key=t,this[r._KEY]=t}},this.FetchByKeysResults=class{constructor(t,e){this.fetchParameters=t,this.results=e,this[r._FETCHPARAMETERS]=t,this[r._RESULTS]=e}},this.ContainsKeysResults=class{constructor(t,e){this.containsParameters=t,this.results=e,this[r._CONTAINSPARAMETERS]=t,this[r._RESULTS]=e}},this.FetchByOffsetResults=class{constructor(t,e,i){this.fetchParameters=t,this.results=e,this.done=i,this[r._FETCHPARAMETERS]=t,this[r._RESULTS]=e,this[r._DONE]=i}},this.FetchListParameters=class{constructor(t,e,i,s){this.size=t,this.sortCriteria=e,this.filterCriterion=i,this.attributes=s,this[r._SIZE]=t,this[r._SORTCRITERIA]=e,this[r._FILTERCRITERION]=i,this[r._ATTRIBUTES]=s}},this.FetchListResult=class{constructor(t,e,i){this.fetchParameters=t,this.data=e,this.metadata=i,this[r._FETCHPARAMETERS]=t,this[r._DATA]=e,this[r._METADATA]=i}},this.AsyncIterable=class{constructor(t){this._asyncIterator=t,this[Symbol.asyncIterator]=function(){return this._asyncIterator}}},this.AsyncIterator=class{constructor(t,e,i,s){this._parent=t,this._nextFunc=e,this._params=i,this._offset=s,this._clientId=i&&i.clientId||Symbol(),t._mapClientIdToOffset.set(this._clientId,s),this._cacheObj={},this._cacheObj[r._MUTATIONSEQUENCENUM]=t._mutationSequenceNum}next(){const t=this._parent._mapClientIdToOffset.get(this._clientId);let e=this._nextFunc(this._params,t,!1,this._cacheObj);return this._parent._mapClientIdToOffset.set(this._clientId,e.offset),Promise.resolve(e.result)}},this.AsyncIteratorYieldResult=class{constructor(t){this.value=t,this[r._VALUE]=t,this[r._DONE]=!1}},this.AsyncIteratorReturnResult=class{constructor(t){this.value=t,this[r._VALUE]=t,this[r._DONE]=!0}},this.DataProviderMutationEventDetail=class{constructor(t,e,i,s){this._parent=t,this.add=e,this.remove=i,this.update=s,this[r._ADD]=e,this[r._REMOVE]=i,this[r._UPDATE]=s,Object.defineProperty(this,r._PARENT,{value:t,enumerable:!1})}},this.DataProviderOperationEventDetail=class{constructor(t,e,i,s,n){this._parent=t,this.keys=e,this.metadata=i,this.data=s,this.indexes=n,this[r._KEYS]=e,this[r._METADATA]=i,this[r._DATA]=s,this[r._INDEXES]=n,Object.defineProperty(this,r._PARENT,{value:t,enumerable:!1})}},this.DataProviderAddOperationEventDetail=class{constructor(t,e,i,s,n,a,l){this._parent=t,this.keys=e,this.afterKeys=i,this.addBeforeKeys=s,this.metadata=n,this.data=a,this.indexes=l,this[r._KEYS]=e,this[r._AFTERKEYS]=i,this[r._ADDBEFOREKEYS]=s,this[r._METADATA]=n,this[r._DATA]=a,this[r._INDEXES]=l,Object.defineProperty(this,r._PARENT,{value:t,enumerable:!1})}},this._sequenceNum=0,this._mutationSequenceNum=0,this._mapClientIdToOffset=new Map,this.data=t}set data(t){let e=null==this._data?[]:this._data.slice();Array.isArray(t)?Object.isFrozen(t)?this._data=t:(this._data=t.slice(),Object.freeze(this._data)):this._data=null==t?[]:[].concat(t),(null==e||0==e.length)&&null!=this._data&&this._data.length>0||(null==this._data||0==this._data.length)&&null!=e&&e.length>0?(this._keys=null,this._dataRefreshed(this._data)):(this._changes=this.compareArrays(e,this._data,!1),null!=this._changes&&this._changes.length>0&&(this._dataMutated(this._changes),this._dataRefreshed(this._data)))}get data(){return this._data}get dataChanges(){return this._changes}containsKeys(t){let e=this;return this.fetchByKeys(t).then(function(s){let n=new i;return t[r._KEYS].forEach(function(t){null!=s[r._RESULTS].get(t)&&n.add(t)}),Promise.resolve(new e.ContainsKeysResults(t,n))})}fetchByKeys(i){let s=this;this._generateKeysIfNeeded();let n,a=new e,l=this._getKeys(),o=null!=i?i[r._ATTRIBUTES]:null,u=0;if(i){let e=s._getRowData();return i[r._KEYS].forEach(function(i){for(n=null,u=0;u<l.length;u++)if(t.Object.compareValues(l[u],i)){n=u;break}if(null!=n&&n>=0){let t=e[n];if(o&&o.length>0){let e={};s._filterRowAttributes(o,t,e),t=e}a.set(i,new s.Item(new s.ItemMetadata(i),t))}}),Promise.resolve(new s.FetchByKeysResults(i,a))}return Promise.reject("Keys are a required parameter")}fetchByOffset(t){let e=this,i=null!=t?t[r._SIZE]:-1,s=null!=t?t[r._SORTCRITERIA]:null,n=null!=t&&t[r._OFFSET]>0?t[r._OFFSET]:0,a=null!=t?t[r._ATTRIBUTES]:null,l=null!=t?t[r._FILTERCRITERION]:null;this._generateKeysIfNeeded();let o=[],u=!0;if(t){let h=new this.FetchListParameters(i,s,l,a),_=this._fetchFrom(h,n,!0).result,d=_[r._VALUE];u=_[r._DONE];let c=d[r._DATA],f=d[r._METADATA].map(function(t){return t[r._KEY]});return o=c.map(function(t,i){return new e.Item(new e.ItemMetadata(f[i]),t)}),Promise.resolve(new this.FetchByOffsetResults(t,o,u))}return Promise.reject("Offset is a required parameter")}fetchFirst(t){return new this.AsyncIterable(new this.AsyncIterator(this,this._fetchFrom.bind(this),t,0))}getCapability(t){return r.getCapability(t)}static _getFetchCapability(){let t=new Set;return t.add("exclusion"),{caching:"all",attributeFilter:{expansion:{},ordering:{},defaultShape:{features:t}}}}static getCapability(t){return"sort"==t?{attributes:"multiple"}:"fetchByKeys"==t?Object.assign({implementation:"lookup"},r._getFetchCapability()):"fetchByOffset"==t?Object.assign({implementation:"randomAccess"},r._getFetchCapability()):"fetchFirst"==t?Object.assign({iterationSpeed:"immediate"},r._getFetchCapability()):"fetchCapability"==t?r._getFetchCapability():"filter"==t?{operators:["$co","$eq","$ew","$pr","$gt","$ge","$lt","$le","$ne","$regex","$sw"],attributeExpression:["*"],textFilter:{}}:null}getTotalSize(){return Promise.resolve(this._getRowData().length)}isEmpty(){return this._getRowData().length>0?"no":"yes"}createOptimizedKeySet(t){return new i(t)}createOptimizedKeyMap(t){if(t){let i=new e;return t.forEach(function(t,e){i.set(e,t)}),i}return new e}_getRowData(){return this[r._DATA]}_getKeys(){return null==this._keys||this._keys instanceof Array?this._keys:this._keys()}_indexOfKey(e){let i,s=this._getKeys(),n=-1;for(i=0;i<s.length;i++)if(t.Object.compareValues(s[i],e)){n=i;break}return n}_adjustIteratorOffset(t,e){this._mapClientIdToOffset.forEach((i,s)=>{let n=0,a=0;t&&t.forEach(function(t){t<i&&++a}),i-=a,e&&e.forEach(function(t){t<i&&++n}),i+=n,this._mapClientIdToOffset.set(s,i)})}compareArrays(t,e,i){return i="boolean"==typeof i?{dontLimitMoves:i}:i||{},e=e||[],(t=t||[]).length<e.length?this.compareSmallArrayToBigArray(t,e,"added","deleted",i):this.compareSmallArrayToBigArray(e,t,"deleted","added",i)}compareSmallArrayToBigArray(t,e,i,s,n){var a,r,l,o,u,h=Math.min,_=Math.max,d=[],c=t.length,f=e.length,E=f-c||1,p=c+f+1;for(a=0;a<=c;a++)for(o=l,d.push(l=[]),u=h(f,a+E),r=_(0,a-1);r<=u;r++)if(r)if(a)if(t[a-1]===e[r-1])l[r]=o[r-1];else{var m=o[r]||p,A=l[r-1]||p;l[r]=h(m,A)+1}else l[r]=r+1;else l[r]=a+1;var T,g=[],y=[],R=[];for(a=c,r=f;a||r;)T=d[a][r]-1,r&&T===d[a][r-1]?y.push(g[g.length]={status:i,value:e[--r],index:r}):a&&T===d[a-1][r]?R.push(g[g.length]={status:s,value:t[--a],index:a}):(--r,--a);return this.findMovesInArrayComparison(R,y,!n.dontLimitMoves&&10*c),g.reverse()}_dataMutated(e){let s,n,r,l,o,u=this,h=[],_=[],d=[],c=[],f=[];u._mutationSequenceNum++;let E=!0,p=!0;e.forEach(function(t){"deleted"===t.status?(E=!1):"added"===t.status&&(p=!1)});let m=[],A=[],T=null,g=null,y=null,R=u._generateKeysIfNeeded();if(!E&&!p){for(s=0;s<e.length;s++){l=e[s].index,o=e[s].status;let i=u._getId(e[s].value);for(n=0;n<e.length;n++)n!=s&&l===e[n].index&&o!==e[n].status&&m.indexOf(s)<0&&A.indexOf(s)<0&&(null==i||t.Object.compareValues(i,u._getId(e[n].value)))&&("deleted"===o?(A.push(s),m.push(n)):(A.push(n),m.push(s)))}for(s=0;s<e.length;s++)if(m.indexOf(s)>=0){let t=u._getKeys()[e[s].index];_.push(t),h.push(e[s].value),d.push(e[s].index)}if(_.length>0){c=_.map(function(t){return new u.ItemMetadata(t)});let t=new i;_.map(function(e){t.add(e)}),T=new u.DataProviderOperationEventDetail(u,t,c,h,d)}}if(h=[],_=[],d=[],!E){for(s=0;s<e.length;s++)"deleted"===e[s].status&&m.indexOf(s)<0&&A.indexOf(s)<0&&(_.push(u._getKeys()[e[s].index]),h.push(e[s].value),d.push(e[s].index));if(_.length>0&&_.map(function(t){let e=u._indexOfKey(t);u._keys.splice(e,1)}),_.length>0){c=_.map(function(t){return new u.ItemMetadata(t)});let t=new i;_.map(function(e){t.add(e)}),y=new u.DataProviderOperationEventDetail(u,t,c,h,d)}}if(h=[],_=[],d=[],!p){let t=null==u._getKeys()||!(u._getKeys().length>0);for(s=0;s<e.length;s++)"added"===e[s].status&&m.indexOf(s)<0&&A.indexOf(s)<0&&(r=u._getId(e[s].value),null==r&&(R||u._keysSpecified)&&(r=u._getKeys()[e[s].index]),null==r?(r=u._sequenceNum++,u._keys.splice(e[s].index,0,r)):t||-1===u._indexOfKey(r)?u._keys.splice(e[s].index,0,r):R||u._keysSpecified||(a.warn("added row has duplicate key "+r),u._keys.splice(e[s].index,0,r)),_.push(r),h.push(e[s].value),d.push(e[s].index));for(s=0;s<e.length;s++)if("added"===e[s].status&&m.indexOf(s)<0&&A.indexOf(s)<0){let t=u._getKeys()[e[s].index+1];t=null==t?null:t,f.push(t)}if(_.length>0){c=_.map(function(t){return new u.ItemMetadata(t)});let t=new i;_.map(function(e){t.add(e)});let e=new i;f.map(function(t){e.add(t)}),g=new u.DataProviderAddOperationEventDetail(u,t,e,f,c,h,d)}}u._fireMutationEvent(g,y,T)}_dataRefreshed(t){var e,i,n,a;let r=this;if(r._mutationEvent){const t=r._mutationEvent.detail;r._adjustIteratorOffset(null===(e=t.remove)||void 0===e?void 0:e.indexes,null===(i=t.add)||void 0===i?void 0:i.indexes),r.dispatchEvent(r._mutationEvent)}else if(r._mutationRemoveEvent||r._mutationAddEvent||r._mutationUpdateEvent){if(r._mutationRemoveEvent){const t=r._mutationRemoveEvent.detail;r._adjustIteratorOffset(null===(n=t.remove)||void 0===n?void 0:n.indexes,null),r.dispatchEvent(r._mutationRemoveEvent)}if(r._mutationAddEvent){const t=r._mutationAddEvent.detail;r._adjustIteratorOffset(null,null===(a=t.add)||void 0===a?void 0:a.indexes),r.dispatchEvent(r._mutationAddEvent)}r._mutationUpdateEvent&&r.dispatchEvent(r._mutationUpdateEvent)}else r.dispatchEvent(new s.DataProviderRefreshEvent);r._mutationEvent=null,r._mutationRemoveEvent=null,r._mutationAddEvent=null,r._mutationUpdateEvent=null}_fireMutationEvent(t,e,i){let n=new this.DataProviderMutationEventDetail(this,t,e,i);this._mutationEvent=new s.DataProviderMutationEvent(n)}_hasSamePropValue(e,i,s){const n="_hasSamePropValue is true";try{e&&e[s]&&e[s].forEach(function(e){i&&i[s]&&i[s].forEach(function(i){if(t.Object.compareValues(e,i))throw n})})}catch(t){if(t===n)return!0;throw t}return!1}_generateKeysIfNeeded(){if(null==this._keys){let t=null!=this.options?this.options[r._KEYATTRIBUTES]:null;this._keys=[];let e,i=this._getRowData(),s=0;for(s=0;s<i.length;s++)e=this._getId(i[s]),null!=e&&"@index"!=t||(e=this._sequenceNum++),this._keys[s]=e;return!0}return!1}_getId(t){let e,i=null;if(null!=this.options&&null!=this.options[r._KEYATTRIBUTES]&&(i=this.options[r._KEYATTRIBUTES]),null!=i){if(Array.isArray(i)){let s;for(e=[],s=0;s<i.length;s++)e[s]=this._getVal(t,i[s])}else e="@value"==i?this._getAllVals(t):this._getVal(t,i);return e}return null}_getVal(t,e){if("string"==typeof e){let i=e.indexOf(".");if(i>0){let s=e.substring(0,i),n=e.substring(i+1),a=t[s];if(a)return this._getVal(a,n)}}return"function"==typeof t[e]?t[e]():t[e]}_getAllVals(t){let e=this;return Object.keys(t).map(function(i){return e._getVal(t,i)})}_fetchFrom(t,e,i,n){let a=this,l=null!=t?t[r._ATTRIBUTES]:null;this._generateKeysIfNeeded();let o=null!=t?t[r._SORTCRITERIA]:null,u=this._getCachedIndexMap(o,n),h=this._getRowData(),_=u.map(function(t){return h[t]}),d=u.map(function(t){return a._getKeys()[t]}),c=null!=t?t[r._SIZE]>0?t[r._SIZE]:t[r._SIZE]<0?a._getKeys().length:25:25,f=e+c<_.length,E=this._mergeSortCriteria(o);null!=E&&((t=t||{})[r._SORTCRITERIA]=E);let p,m=[],A=[],T=0;if(null!=t&&t[r._FILTERCRITERION]){let i=null;i=s.FilterFactory.getFilter({filterDef:t[r._FILTERCRITERION],filterOptions:this.options});let n=0;for(;m.length<c&&n<_.length;)i.filter(_[n])&&(T>=e&&(m.push(_[n]),A.push(d[n])),T++),n++;f=n<_.length}else m=_.slice(e,e+c),A=d.slice(e,e+c);T=e+m.length,p=m.map(function(t){if(l&&l.length>0){let e={};a._filterRowAttributes(l,t,e),t=e}return t});let g=A.map(function(t){return new a.ItemMetadata(t)}),y=new this.FetchListResult(t,p,g);return(i?f:y.data.length>0)?{result:new this.AsyncIteratorYieldResult(y),offset:T}:{result:new this.AsyncIteratorReturnResult(y),offset:T}}_getCachedIndexMap(t,e){if(e&&e.indexMap&&e[r._MUTATIONSEQUENCENUM]===this._mutationSequenceNum)return e.indexMap;let i=this._getRowData().map(function(t,e){return e}),s=this._sortData(i,t);return e&&(e.indexMap=s,e[r._MUTATIONSEQUENCENUM]=this._mutationSequenceNum),s}_sortData(t,e){let i=this._getRowData(),s=t.map(function(t){return{index:t,value:i[t]}});return null!=e&&s.sort(this._getSortComparator(e)),s.map(function(t){return t.index})}_getSortComparator(t){let e=this;return function(i,s){let n,a,l,o,u,h,_=null!=e.options?e.options[r._SORTCOMPARATORS]:null;for(n=0;n<t.length;n++)if(a=t[n][r._DIRECTION],l=t[n][r._ATTRIBUTE],o=null,null!=_&&(o=_[r._COMPARATORS].get(l)),u=e._getVal(i.value,l),h=e._getVal(s.value,l),null!=o){let t="descending"==a?-1:1,e=o(u,h)*t;if(0!=e)return e}else{let t=0,e="string"==typeof u?u:new String(u).toString(),i="string"==typeof h?h:new String(h).toString();if(t="ascending"==a?e.localeCompare(i,void 0,{numeric:!0,sensitivity:"base"}):i.localeCompare(e,void 0,{numeric:!0,sensitivity:"base"}),0!=t)return t}return 0}}_mergeSortCriteria(t){let e=null!=this.options?this.options[r._IMPLICITSORT]:null;if(null!=e){if(null==t)return e;let i,s,n,a=t.slice(0);for(i=0;i<e.length;i++){for(n=!1,s=0;s<a.length;s++)a[s][r._ATTRIBUTE]==e[i][r._ATTRIBUTE]&&(n=!0);n||a.push(e[i])}return a}return t}_filterRowAttributes(t,e,i){let s=this;if(Array.isArray(t)){let n,a=!1;t.forEach(function(t){t!=r._ATDEFAULT&&t.name!=r._ATDEFAULT||(a=!0)}),Object.keys(e).forEach(function(r){if(a){let a,l=!1,o=r;for(n=0;n<t.length;n++)if(a=t[n]instanceof Object?t[n].name:t[n],a.startsWith("!")){if(a=a.substr(1,a.length-1),a==r){l=!0;break}}else if(a==r){o=t[n];break}l||s._filterRowAttributes(o,e,i)}else t.forEach(function(t){let n;n=t instanceof Object?t.name:t,n.startsWith("!")||n!=r||s._filterRowAttributes(t,e,i)})})}else if(t instanceof Object){let n=t.name,a=t.attributes;if(n&&!n.startsWith("!"))if(e[n]instanceof Object&&!Array.isArray(e[n])&&a){let t={};s._filterRowAttributes(a,e[n],t),i[n]=t}else if(Array.isArray(e[n])&&a){let t;i[n]=[],e[n].forEach(function(e,r){t={},s._filterRowAttributes(a,e,t),i[n][r]=t})}else s._proxyAttribute(i,e,n)}else s._proxyAttribute(i,e,t)}_proxyAttribute(t,e,i){t&&e&&Object.defineProperty(t,i,{get:function(){return e[i]},set:function(t){e[i]=t},enumerable:!0})}}return r._KEY="key",r._KEYS="keys",r._AFTERKEYS="afterKeys",r._ADDBEFOREKEYS="addBeforeKeys",r._DIRECTION="direction",r._ATTRIBUTE="attribute",r._ATTRIBUTES="attributes",r._SORT="sort",r._SORTCRITERIA="sortCriteria",r._FILTERCRITERION="filterCriterion",r._DATA="_data",r._METADATA="metadata",r._INDEXES="indexes",r._OFFSET="offset",r._SIZE="size",r._IMPLICITSORT="implicitSort",r._KEYATTRIBUTES="keyAttributes",r._SORTCOMPARATORS="sortComparators",r._COMPARATORS="comparators",r._COMPARATOR="comparator",r._RESULTS="results",r._CONTAINS="contains",r._FETCHPARAMETERS="fetchParameters",r._CONTAINSPARAMETERS="containsParameters",r._VALUE="value",r._DONE="done",r._ADD="add",r._REMOVE="remove",r._UPDATE="update",r._DETAIL="detail",r._FETCHLISTRESULT="fetchListResult",r._ATDEFAULT="@default",r._MUTATIONSEQUENCENUM="mutationSequenceNum",r._PARENT="_parent",n.EventTargetMixin.applyMixin(r),r});
//# sourceMappingURL=ojmutablearraydataprovider.js.map
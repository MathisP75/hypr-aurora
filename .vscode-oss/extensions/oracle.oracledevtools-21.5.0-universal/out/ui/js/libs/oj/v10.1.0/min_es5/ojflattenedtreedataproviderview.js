!function(){function e(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function t(e,t){for(var a=0;a<t.length;a++){var i=t[a];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function a(e,a,i){return a&&t(e.prototype,a),i&&t(e,i),e}
/**
 * @license
 * Copyright (c) 2014, 2021, Oracle and/or its affiliates.
 * Licensed under The Universal Permissive License (UPL), Version 1.0
 * as shown at https://oss.oracle.com/licenses/upl/
 * @ignore
 */define(["ojs/ojcore-base","ojs/ojset","ojs/ojeventtarget","ojs/ojkeyset","ojs/ojobservable","ojs/ojmap"],function(t,i,r,n,s,h){"use strict";t=t&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t,i=i&&Object.prototype.hasOwnProperty.call(i,"default")?i.default:i,h=h&&Object.prototype.hasOwnProperty.call(h,"default")?h.default:h;
/**
   * @license
   * Copyright (c) 2014, 2021, Oracle and/or its affiliates.
   * The Universal Permissive License (UPL), Version 1.0
   * as shown at https://oss.oracle.com/licenses/upl/
   * @ignore
   */
/**
   * @preserve Copyright 2013 jQuery Foundation and other contributors
   * Released under the MIT license.
   * http://jquery.org/license
   */
var u=function(){function r(t,i){e(this,r),this.dataProvider=t,this.options=i,this._DATAPROVIDER="dataprovider",this._EXPANDED="expanded",this._KEY="key",this._PARENTKEY="parentKey",this._INDEXFROMPARENT="indexFromParent",this._TREEDEPTH="treeDepth",this._ISLEAF="isLeaf",this._KEYS="keys",this._OFFSET="offset",this._SIZE="size",this._DONE="done",this._VALUE="value",this._DATA="data",this._REFRESH="refresh",this._MUTATE="mutate",this._SORTCRITERIA="sortCriteria",this._FILTERCRITERION="filterCriterion",this._ATTRIBUTES="attributes",this._METADATA="metadata",this._RESULTS="results",this._FETCHPARAMETERS="fetchParameters",this._CONTAINSPARAMETERS="containsParameters",this._CONTAINSKEYS="containsKeys",this._FETCHBYKEYS="fetchByKeys",this._FETCHBYOFFSET="fetchByOffset",this._AFTERKEYS="afterKeys",this._ADDBEFOREKEYS="addBeforeKeys",this._ADD="add",this._REMOVE="remove",this._UPDATE="update",this._INDEXES="indexes",this._ADDEVENTLISTENER="addEventListener",this.AsyncIterable=function(){return function t(a,i){e(this,t),this._parent=a,this._asyncIterator=i,this[Symbol.asyncIterator]=function(){return this._asyncIterator}}}(),this.AsyncIterator=function(){function t(a,i,r){e(this,t),this._parent=a,this._nextFunc=i,this._params=r}return a(t,[{key:"next",value:function(){var e=this._nextFunc(this._params);return Promise.resolve(e)}}]),t}(),this.AsyncIteratorYieldResult=function(){return function t(a,i){e(this,t),this._parent=a,this.value=i,this[a._VALUE]=i,this[a._DONE]=!1}}(),this.AsyncIteratorReturnResult=function(){return function t(a,i){e(this,t),this._parent=a,this.value=i,this[a._VALUE]=i,this[a._DONE]=!0}}(),this.Item=function(){return function t(a,i,r){e(this,t),this._parent=a,this.metadata=i,this.data=r,this[a._METADATA]=i,this[a._DATA]=r}}(),this.FlattenedTreeItemMetadata=function(){return function t(a,i,r,n,s,h){e(this,t),this._parent=a,this.key=i,this.parentKey=r,this.indexFromParent=n,this.treeDepth=s,this.isLeaf=h,this[a._KEY]=i,this[a._PARENTKEY]=r,this[a._INDEXFROMPARENT]=n,this[a._TREEDEPTH]=s,this[a._ISLEAF]=h}}(),this.FetchListParameters=function(){return function t(a,i,r,n){e(this,t),this._parent=a,this.size=i,this.sortCriteria=r,this.filterCriterion=n,this[a._SIZE]=i,this[a._SORTCRITERIA]=r,this[a._FILTERCRITERION]=n}}(),this.FetchListResult=function(){return function t(a,i,r,n){e(this,t),this._parent=a,this.fetchParameters=i,this.data=r,this.metadata=n,this[a._FETCHPARAMETERS]=i,this[a._DATA]=r,this[a._METADATA]=n}}(),this.FetchByOffsetParameters=function(){return function t(a,i,r,n,s,h){e(this,t),this._parent=a,this.offset=i,this.size=r,this.sortCriteria=n,this.filterCriterion=s,this.attributes=h,this[a._OFFSET]=i,this[a._SIZE]=r,this[a._SORTCRITERIA]=n,this[a._FILTERCRITERION]=s,this[a._ATTRIBUTES]=h}}(),this.FetchByOffsetResults=function(){return function t(a,i,r,n){e(this,t),this._parent=a,this.fetchParameters=i,this.results=r,this.done=n,this[a._FETCHPARAMETERS]=i,this[a._RESULTS]=r,this[a._DONE]=n}}(),this.FetchByKeysResults=function(){return function t(a,i,r){e(this,t),this._parent=a,this.fetchParameters=i,this.results=r,this[a._FETCHPARAMETERS]=i,this[a._RESULTS]=r}}(),this.ContainsKeysResults=function(){return function t(a,i,r){e(this,t),this._parent=a,this.containsParameters=i,this.results=r,this[a._CONTAINSPARAMETERS]=i,this[a._RESULTS]=r}}(),this.DataProviderMutationEventDetail=function(){return function t(a,i,r,n){e(this,t),this._parent=a,this.add=i,this.remove=r,this.update=n,this[a._ADD]=i,this[a._REMOVE]=r,this[a._UPDATE]=n}}(),this.DataProviderRefreshEventDetail=function(){return function t(a){e(this,t),this.disregardAfterKey=a,this.disregardAfterKey=a}}(),this.DataProviderOperationEventDetail=function(){return function t(a,i,r,n,s){e(this,t),this._parent=a,this.keys=i,this.metadata=r,this.data=n,this.indexes=s,this[a._KEYS]=i,this[a._METADATA]=r,this[a._DATA]=n,this[a._INDEXES]=s}}(),this.DataProviderAddOperationEventDetail=function(){return function t(a,i,r,n,s,h,u){e(this,t),this._parent=a,this.keys=i,this.afterKeys=r,this.addBeforeKeys=n,this.metadata=s,this.data=h,this.indexes=u,this[a._KEYS]=i,this[a._AFTERKEYS]=r,this[a._ADDBEFOREKEYS]=n,this[a._METADATA]=s,this[a._DATA]=h,this[a._INDEXES]=u}}();null==this.options&&(this.options={}),this.options.expanded||(this.options.expanded=new n.ExpandedKeySet([])),this._expandedObservable=new s.BehaviorSubject(this._getExpandedObservableValue(this.options.expanded,Promise.resolve())),this.dataProvider.addEventListener("mutate",this._handleUnderlyingMutation.bind(this)),this.dataProvider.addEventListener("refresh",this._handleUnderlyingRefresh.bind(this)),this._cache=[],this._iterators=new h,this._done=!1}return a(r,[{key:"_handleUnderlyingMutation",value:function(e){var a=this,i=null,r=null,n=null,s=e.detail.add;if(s&&s.data&&s.data.length){var h=[],u=[],o=[],d=[],c=[],l=new Set,f=new Set;s.parentKeys.forEach(function(e,t){if(null===e||a._isExpanded(e)&&a._getItemByKey(e)){var i;if(null!=s.addBeforeKeys)i=a._getItemIndexByKey(s.addBeforeKeys[t])-1;else if(null!=s.indexes){var r=a._getItemIndexByKey(e);i=-1===r?s.indexes[t]:r+s.indexes[t]}else i=a._getItemIndexByKey(a._getLastItemByParentKey(e).metadata.key)+1;var n=a._updateItemMetadata(new a.Item(a,s.metadata[t],s.data[t]),e,s.indexes[t]);a._spliceItemToCache(n,i),u.push(n.data),h.push(n.metadata),o.push(i),d.push(s.addBeforeKeys[t]),c.push(e),l.add(s.addBeforeKeys[t]),f.add(s.metadata[t].key),a._incrementIteratorOffset(i)}}),i=new a.DataProviderAddOperationEventDetail(a,f,l,d,h,u,o)}var _=e.detail.remove;if(_&&_.data&&_.data.length){var y=_.metadata.map(function(e){return e.key}),E=[],v=[],m=[],p=new Set;y.forEach(function(e){var t=a._getLocalDescendentCount(e)+1,i=a._getItemIndexByKey(e);a._cache.splice(i,t).forEach(function(e,t){p.add(e.metadata.key),E.push(e.metadata),v.push(e.data),m.push(i+t),a._decrementIteratorOffset(i)})}),r=new a.DataProviderOperationEventDetail(a,p,E,v,m)}var I=e.detail.update;if(I&&I.data&&I.data.length){var T=[],R=[],O=[],A=new Set;I.metadata.forEach(function(e,t){var i=a._getItemByKey(e.key);if(null!=i){var r=a._getItemIndexByKey(e.key),n=I.data[t],s=new a.FlattenedTreeItemMetadata(a,i.metadata.key,i.metadata.parentKey,i.metadata.indexFromParent,i.metadata.treeDepth,null===a.getChildDataProvider(i.metadata.key));a._cache.splice(r,1,new a.Item(a,s,n)),A.add(i.metadata.key),T.push(i.metadata),R.push(i.data),O.push(r)}}),n=new a.DataProviderOperationEventDetail(a,A,T,R,O)}var P=new a.DataProviderMutationEventDetail(a,i,r,n);a.dispatchEvent(new t.DataProviderMutationEvent(P))}},{key:"_handleUnderlyingRefresh",value:function(){this._clearCache(),this.dispatchEvent(new t.DataProviderRefreshEvent)}},{key:"_getExpandedObservableValue",value:function(e,t){return{value:e,completionPromise:t}}},{key:"getChildDataProvider",value:function(e,t){return this.dataProvider.getChildDataProvider(e,t)}},{key:"containsKeys",value:function(e){return this.dataProvider.containsKeys(e)}},{key:"fetchByKeys",value:function(e){var t=this;return this.dataProvider.fetchByKeys(e).then(function(e){var a=new h;return e.results.forEach(function(e,i){var r=t._getItemByKey(i);r?a.set(i,r):a.set(i,e)}),new t.FetchByKeysResults(t,e.fetchParameters,a)})}},{key:"fetchByOffset",value:function(e){var t=this,a=null!=e?e[this._SIZE]:-1,i=null!=e?e[this._SORTCRITERIA]:null,r=null!=e&&e[this._OFFSET]>0?e[this._OFFSET]:0,n=null!=e?e[this._FILTERCRITERION]:null,s=null!=e?e[this._ATTRIBUTES]:null;if(e=new t.FetchByOffsetParameters(t,r,a,i,n,s),t._isSameCriteria(i,n)){if(t._checkCacheByOffset(e))return new Promise(function(a){a(t._getFetchByOffsetResultsFromCache(e))})}else t._clearCache(),t._currentSortCriteria=i,t._currentFilterCriteria=n;return t._fetchByOffset(e)}},{key:"fetchFirst",value:function(e){var t=this;t._fetchSize=null!=e?e[this._SIZE]:-1;var a=null!=e?e[this._SORTCRITERIA]:null,i=null!=e?e[this._FILTERCRITERION]:null,r=null!=e?e[this._ATTRIBUTES]:null;t._isSameCriteria(a,i)||(t._currentSortCriteria=a,t._currentFilterCriteria=i,t._clearCache());var n=new t.AsyncIterable(t,new t.AsyncIterator(t,function(){var e=t._iterators.get(n),s=new t.FetchByOffsetParameters(t,e,t._fetchSize,a,i,r);return t.fetchByOffset(s).then(function(a){var i=a.results,r=i.map(function(e){return e[t._DATA]}),h=i.map(function(e){return e[t._METADATA]}),u=0===r.length||a[t._DONE];return t._iterators.set(n,e+h.length),u?Promise.resolve(new t.AsyncIteratorReturnResult(t,new t.FetchListResult(t,s,r,h))):Promise.resolve(new t.AsyncIteratorYieldResult(t,new t.FetchListResult(t,s,r,h)))})},e));return t._iterators.set(n,0),n}},{key:"getCapability",value:function(e){return this.dataProvider.getCapability(e)}},{key:"getTotalSize",value:function(){return Promise.resolve(-1)}},{key:"isEmpty",value:function(){return this.dataProvider.isEmpty()}},{key:"_isSameCriteria",value:function(e,t){if(e){if(!this._currentSortCriteria||e[0].attribute!=this._currentSortCriteria[0].attribute||e[0].direction!=this._currentSortCriteria[0].direction)return!1}else if(this._currentSortCriteria)return!1;if(t){if(!this._currentFilterCriteria||t[0].op!=this._currentFilterCriteria[0].op||t[0].filter!=this._currentFilterCriteria[0].filter)return!1}else if(this._currentFilterCriteria)return!1;return!0}},{key:"_checkCacheByOffset",value:function(e,t){if(-1===e[this._SIZE]&&!0===this._done)return!0;if(null!=t){if(this._getLocalDescendentCount(t)>=e[this._SIZE]&&-1!==e[this._SIZE])return!0}else if(this._cache.length>=e[this._OFFSET]+e[this._SIZE]&&-1!==e[this._SIZE])return!0;return!1}},{key:"_getFetchByOffsetResultsFromCache",value:function(e){var t=this._cache.slice(e[this._OFFSET],-1===e[this._SIZE]?void 0:e[this._OFFSET]+e[this._SIZE]),a=!1;return 0==t.length&&(this._lastParams&&this._lastParams==e?a=!0:this._lastParams=e),new this.FetchByOffsetResults(this,e,t,a)}},{key:"_clearCache",value:function(){this._cache=[]}},{key:"_fetchByOffset",value:function(e){if(0===this._cache.length){var t=-1===e[this._SIZE]?-1:e[this._OFFSET]+e[this._SIZE],a=new this.FetchByOffsetParameters(this,0,t,e[this._SORTCRITERIA],e[this._FILTERCRITERION],e[this._ATTRIBUTES]);return this._fetchChildrenByOffsetFromDataProvider(a,this.dataProvider,null,e)}var i=this._getLastEntry(),r=i.metadata.key,n=0;!i.metadata.isLeaf&&this._isExpanded(r)||(r=i.metadata.parentKey,n=i.metadata.indexFromParent+1);var s=null===r?this.dataProvider:this.getChildDataProvider(r),h=this._getRemainingSize(e),u=new this.FetchByOffsetParameters(this,n,h,e[this._SORTCRITERIA],e[this._FILTERCRITERION],e[this._ATTRIBUTES]);return this._fetchChildrenByOffsetFromAncestors(u,s,r,e)}},{key:"_fetchChildrenByOffsetFromAncestors",value:function(e,t,a,i,r){var n=this;return n._fetchChildrenByOffsetFromDataProvider(e,t,a,i,r).then(function t(a,s){var h=n._getItemByKey(a);if(n._checkCacheByOffset(i,r)||s[n._DONE]&&null===a||null===h)return Promise.resolve();var u=h.metadata.parentKey,o=h.metadata.indexFromParent,d=null===u?n.dataProvider:n.getChildDataProvider(u),c=new n.FetchByOffsetParameters(n,o+1,n._getRemainingSize(i),e[n._SORTCRITERIA],e[n._FILTERCRITERION],e[n._ATTRIBUTES]);return n._fetchChildrenByOffsetFromDataProvider(c,d,u,i,r).then(t.bind(n,u))}.bind(n,a)).then(n._getFetchByOffsetResultsFromCache.bind(n,i))}},{key:"_fetchChildrenByOffsetFromDataProvider",value:function(e,t,a,i,r){var n=this;return t.fetchByOffset(e).then(function t(s){var h=s.results;if(0===h.length||n._checkCacheByOffset(i,r))return Promise.resolve();var u=h.shift(),o=n._updateItemMetadata(u,a);if(n._pushItemToCache(o,a),n._isExpanded(o.metadata.key)){var d=n.getChildDataProvider(o.metadata.key);if(null!=d){var c=new n.FetchByOffsetParameters(n,0,n._getRemainingSize(i),e[n._SORTCRITERIA],e[n._FILTERCRITERION],e[n._ATTRIBUTES]);return n._fetchChildrenByOffsetFromDataProvider(c,d,o.metadata.key,i,r).then(t.bind(n,new n.FetchByOffsetResults(n,e,h,!1)))}}return t(new n.FetchByOffsetResults(n,e,h,!1))}).then(n._getFetchByOffsetResultsFromCache.bind(n,i))}},{key:"_sequence",value:function(e,t){return e.reduce(function(e,a){return e.then(function(){return t(a)})},Promise.resolve())}},{key:"_getRemainingSize",value:function(e){return-1===e[this._SIZE]?-1:e[this._SIZE]+e[this._OFFSET]-this._cache.length}},{key:"_getExpandedKeysFromResults",value:function(e){var t=this;return e.map(function(e){return e.metadata.key}).filter(function(e){return t._isExpanded(e)})}},{key:"_isExpanded",value:function(e){return this.options[this._EXPANDED].has(e)}},{key:"setExpanded",value:function(e){var a=this,i=a.createOptimizedKeySet(),r=a.createOptimizedKeySet();a._oldExpanded=a.options.expanded,a.options.expanded=e;var n=a._oldExpanded,s=a.options.expanded;if(s.isAddAll()||n.isAddAll()){if(!s.isAddAll()||!n.isAddAll())return a._clearCache(),a.dispatchEvent(new t.DataProviderRefreshEvent),void a.getExpandedObservable().next(a._getExpandedObservableValue(this.options.expanded,Promise.resolve()));var h=s.deletedValues(),u=n.deletedValues();h.forEach(function(e){n.has(e)&&r.add(e)}),u.forEach(function(e){s.has(e)&&i.add(e)})}else{var o=s.values(),d=n.values();o.forEach(function(e){n.has(e)||i.add(e)}),d.forEach(function(e){s.has(e)||r.add(e)})}var c=a._expand(i),l=a._collapse(r),f=new Promise(function(e){c.then(function(i){var r=i.operationAddEventDetail,n=i.fetchedCountMap,s=null,h=null;(-1!==a._fetchSize&&n.forEach(function(e,t){if(e>=a._fetchSize){var i=a._getItemIndexByKey(t);(i<h||null===h)&&(h=i,s=t)}}),null!==h)&&a._cache.splice(h+1,a._cache.length).forEach(function(){a._decrementIteratorOffset(h+1)});if(null===s){var u=new a.DataProviderMutationEventDetail(a,r,l,null);a.dispatchEvent(new t.DataProviderMutationEvent(u))}if(null!==s){var o=new t.DataProviderRefreshEvent(new a.DataProviderRefreshEventDetail(s));a.dispatchEvent(o)}e()})});a.getExpandedObservable().next(a._getExpandedObservableValue(this.options.expanded,f))}},{key:"getExpandedObservable",value:function(){return this._expandedObservable}},{key:"_isExpandAll",value:function(){return this.options[this._EXPANDED].isAddAll()}},{key:"_pushItemToCache",value:function(e,t){var a=this._getLastItemByParentKey(t),i=null==a?this._getItemIndexByKey(t):this._getItemIndexByKey(a.metadata.key)+this._getLocalDescendentCount(a.metadata.key);this._cache.splice(i+1,0,e)}},{key:"_spliceItemToCache",value:function(e,t){this._cache.splice(t+1,0,e)}},{key:"_updateItemMetadata",value:function(e,t,a){var i=0,r=this._getLastItemByParentKey(t),n=null==r?0:r.metadata[this._INDEXFROMPARENT]+1;(null!=a&&(n=a),null!=t)&&(i=this._getItemByKey(t).metadata.treeDepth+1);return new this.Item(this,new this.FlattenedTreeItemMetadata(this,e.metadata.key,t,n,i,null===this.getChildDataProvider(e.metadata.key)),e.data)}},{key:"_getItemByKey",value:function(e){var t=null;return this._cache.some(function(a){if(a.metadata.key===e)return t=a,!0}),t}},{key:"_getItemIndexByKey",value:function(e){var t=-1;return this._cache.some(function(a,i){if(a.metadata.key===e)return t=i,!0}),t}},{key:"_getLastEntry",value:function(){return this._cache[this._getLastIndex()]}},{key:"_getEntry",value:function(e){return this._cache[e]}},{key:"_getLastItemByParentKey",value:function(e){var t=null;return this._cache.slice().reverse().some(function(a){if(a.metadata.parentKey===e)return t=a,!0}),t}},{key:"_getLastIndex",value:function(){return this._cache.length-1}},{key:"_getLocalDescendentCount",value:function(e){var t=this._getItemByKey(e),a=0;if(null!=t)for(var i=this._getItemIndexByKey(e),r=t.metadata.treeDepth,n=this._getLastIndex(),s=i+1;s<=n;s++){if(!(this._getEntry(s).metadata.treeDepth>r))return a;a+=1}return a}},{key:"_expand",value:function(e){var t=[],a=this;return e.forEach(function(e){var i=new a.FetchByOffsetParameters(a,0,a._fetchSize,a._currentSortCriteria,a._currentFilterCriteria,null),r=a.getChildDataProvider(e);t.push(a._fetchChildrenByOffsetFromDataProvider(i,r,e,i,e))}),Promise.all(t).then(function(){var t=a.createOptimizedKeySet(),i=a.createOptimizedKeySet(),r=[],n=[],s=[],h=new Map;return e.forEach(function(e){var u=a._getLocalDescendentCount(e);if(u>0){h.set(e,u);var o=a._getItemIndexByKey(e)+1,d=null;a._cache.slice(o,o+u).forEach(function(e,h){t.add(e.metadata.key),i.add(d),r.push(e.metadata),n.push(e.data),s.push(o+h),d=e.metadata.key,a._incrementIteratorOffset(o)})}}),{operationAddEventDetail:new a.DataProviderAddOperationEventDetail(a,t,i,[],r,n,s),fetchedCountMap:h}})}},{key:"_collapse",value:function(e){var t=this,a=[],i=[],r=[],n=t.createOptimizedKeySet();return e.forEach(function(e){var s=t._getLocalDescendentCount(e);if(s>0){var h=t._getItemIndexByKey(e);t._cache.splice(h+1,s).forEach(function(e,s){n.add(e.metadata.key),a.push(e.metadata),i.push(e.data),r.push(h+s+1),t._decrementIteratorOffset(h+1)})}}),new t.DataProviderOperationEventDetail(t,n,a,i,r)}},{key:"_decrementIteratorOffset",value:function(e){var t=this;t._iterators.forEach(function(a,i){e<a&&t._iterators.set(i,a-1)})}},{key:"_incrementIteratorOffset",value:function(e){var t=this;t._iterators.forEach(function(a,i){e<a&&t._iterators.set(i,a+1)})}},{key:"createOptimizedKeySet",value:function(e){return this.dataProvider.createOptimizedKeySet?this.dataProvider.createOptimizedKeySet(e):new i(e)}},{key:"createOptimizedKeyMap",value:function(e){if(this.dataProvider.createOptimizedKeyMap)return this.dataProvider.createOptimizedKeyMap(e);if(e){var t=new h;return e.forEach(function(e,a){t.set(a,e)}),t}return new h}}]),r}();return t._registerLegacyNamespaceProp("FlattenedTreeDataProviderView",u),t.EventTargetMixin.applyMixin(u),u})}();
//# sourceMappingURL=ojflattenedtreedataproviderview.js.map
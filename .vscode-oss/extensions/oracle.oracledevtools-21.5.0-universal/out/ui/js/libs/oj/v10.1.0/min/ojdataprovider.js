/**
 * @license
 * Copyright (c) 2014, 2021, Oracle and/or its affiliates.
 * Licensed under The Universal Permissive License (UPL), Version 1.0
 * as shown at https://oss.oracle.com/licenses/upl/
 * @ignore
 */
define(["exports","ojs/ojcore-base","ojs/ojeventtarget"],function(t,e,r){"use strict";e=e&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e,
/**
     * @license
     * Copyright (c) 2014, 2021, Oracle and/or its affiliates.
     * The Universal Permissive License (UPL), Version 1.0
     * as shown at https://oss.oracle.com/licenses/upl/
     * @ignore
     */
/**
     * @preserve Copyright 2013 jQuery Foundation and other contributors
     * Released under the MIT license.
     * http://jquery.org/license
     */
oj.DataProvider=function(){},function(t){let e;!function(t){t.$co="$co",t.$eq="$eq",t.$ew="$ew",t.$pr="$pr",t.$gt="$gt",t.$ge="$ge",t.$lt="$lt",t.$le="$le",t.$ne="$ne",t.$regex="$regex",t.$sw="$sw"}(e=t.AttributeOperator||(t.AttributeOperator={}))}(t.AttributeFilterOperator||(t.AttributeFilterOperator={})),e._registerLegacyNamespaceProp("AttributeFilterOperator",t.AttributeFilterOperator),function(t){let e;!function(t){t.$and="$and",t.$or="$or"}(e=t.CompoundOperator||(t.CompoundOperator={}))}(t.CompoundFilterOperator||(t.CompoundFilterOperator={})),e._registerLegacyNamespaceProp("CompoundFilterOperator",t.CompoundFilterOperator);class i{constructor(){this._handleMutationAdd=function(t){var r,a;let s=this,n=t[i._BEFOREKEYS],o=t[i._KEYS],l=[];o.forEach(function(t){l.push(t)});let f=t[i._DATA],u=t[i._METADATA],c=t[i._INDEXES];if(l&&l.length>0)if(c)l.forEach(function(t,e){s._items.splice(c[e],0,new s.Item(u[e],f[e]))});else if(n){let o,c,h,p,_,m=Object.assign([],n),y=Object.assign(new Set,t[i._KEYS]),g=Object.assign([],t[i._DATA]),d=Object.assign([],t[i._METADATA]),E=[];for(o=0;o<n.length;o++){if(h=n[o],_=!0,null!=h){for(c=0;c<l.length;c++)if(e.Object.compareValues(l[c],h)){_=!1;break}if(_)for(c=0;c<s._items.length;c++)if(e.Object.compareValues(null===(a=null===(r=s._items[c])||void 0===r?void 0:r.metadata)||void 0===a?void 0:a.key,h)){_=!1;break}}else _=!1;_&&E.push(h)}let b=n.length;for(;b>0;){for(o=0;o<n.length;o++)if(p=n[o],E.indexOf(p)>=0){E.push(p);break}b--}for(o=m.length-1;o>=0;o--)E.indexOf(m[o])>=0&&(delete m[o],y.delete(m[o]),delete g[o],delete d[o]);m.forEach(function(t,r){var i,a;if(null===t)s._items.push(new s.Item(u[r],f[r]));else for(o=0;o<s._items.length;o++)if(e.Object.compareValues(null===(a=null===(i=s._items[o])||void 0===i?void 0:i.metadata)||void 0===a?void 0:a.key,t)){s._items.splice(o,0,new s.Item(u[r],f[r]));break}})}else if(s._fetchParams&&null!=s._fetchParams.sortCriteria){let t=s._fetchParams.sortCriteria;if(t){let e,r,i,a=s._getSortComparator(t),n=[];f.forEach(function(t,o){for(e=0;e<s._items.length;e++)if(r=s._items[e].data,i=a(t,r),i<0){s._items.splice(e,0,new s.Item(u[o],f[o])),n.push(o);break}}),f.forEach(function(t,e){n.indexOf(e)<0&&s._items.push(new s.Item(u[e],f[e]))})}}else f.forEach(function(t,e){s._items.push(new s.Item(u[e],f[e]))})},this._handleMutationRemove=function(t){let r=this,a=t[i._KEYS];if(a&&a.size>0){let t;a.forEach(function(i){for(t=r._items.length-1;t>=0;t--)if(e.Object.compareValues(r._items[t].metadata.key,i)){r._items.splice(t,1);break}})}},this._handleMutationUpdate=function(t){let r=this,a=t[i._KEYS],s=t[i._DATA],n=t[i._METADATA];if(s&&s.length>0){let t,i=0;a.forEach(function(a){for(t=r._items.length-1;t>=0;t--)if(e.Object.compareValues(r._items[t].metadata.key,a)){r._items.splice(t,1,new r.Item(n[i],s[i]));break}i++})}},this.Item=class{constructor(t,e){this.metadata=t,this.data=e,this[i._METADATA]=t,this[i._DATA]=e}},this.FetchByKeysResults=class{constructor(t,e){this.fetchParameters=t,this.results=e,this[i._FETCHPARAMETERS]=t,this[i._RESULTS]=e}},this.FetchByOffsetResults=class{constructor(t,e,r){this.fetchParameters=t,this.results=e,this.done=r,this[i._FETCHPARAMETERS]=t,this[i._RESULTS]=e,this[i._DONE]=r}},this._items=[]}addListResult(t){let e=this,r=[];t.value.data.forEach(function(i,a){r.push(new e.Item(t.value.metadata[a],i))}),this._items=this._items.concat(r),this._done=t.done}getDataList(t,e){this._fetchParams=t;let r=25;null!=t.size&&(r=-1==t.size?this.getSize():t.size);let i=this._items.slice(e,e+r),a=[],s=[];return i.forEach(function(t){a.push(t.data),s.push(t.metadata)}),{fetchParameters:t,data:a,metadata:s}}getDataByKeys(t){let e=this,r=new Map;if(t&&t.keys){let i;t.keys.forEach(function(t){for(i=0;i<e._items.length;i++)if(e._items[i].metadata.key==t){r.set(t,e._items[i]);break}})}return new this.FetchByKeysResults(t,r)}getDataByOffset(t){let e=[];return t&&(e=this._items.slice(t.offset,t.offset+t.size)),new this.FetchByOffsetResults(t,e,!0)}processMutations(t){null!=t.remove&&this._handleMutationRemove(t.remove),null!=t.add&&this._handleMutationAdd(t.add),null!=t.update&&this._handleMutationUpdate(t.update)}reset(){this._items=[],this._done=!1}getSize(){return this._items.length}isDone(){return this._done}_getSortComparator(t){let e=this;return function(r,a){let s,n,o,l,f,u;for(s=0;s<t.length;s++){n=t[s][i._DIRECTION],o=t[s][i._ATTRIBUTE],l=null,f=e._getVal(r,o),u=e._getVal(a,o);let c=0,h="string"==typeof f?f:new String(f).toString(),p="string"==typeof u?u:new String(u).toString();if(c="ascending"==n?h.localeCompare(p,void 0,{numeric:!0,sensitivity:"base"}):p.localeCompare(h,void 0,{numeric:!0,sensitivity:"base"}),0!=c)return c}return 0}}_getVal(t,e){if("string"==typeof e){let r=e.indexOf(".");if(r>0){let i=e.substring(0,r),a=e.substring(r+1),s=t[i];if(s)return this._getVal(s,a)}}return"function"==typeof t[e]?t[e]():t[e]}}i._DATA="data",i._METADATA="metadata",i._ITEMS="items",i._BEFOREKEYS="addBeforeKeys",i._KEYS="keys",i._INDEXES="indexes",i._FROM="from",i._OFFSET="offset",i._REFRESH="refresh",i._MUTATE="mutate",i._SIZE="size",i._FETCHPARAMETERS="fetchParameters",i._SORTCRITERIA="sortCriteria",i._DIRECTION="direction",i._ATTRIBUTE="attribute",i._VALUE="value",i._DONE="done",i._RESULTS="results",i._CONTAINSPARAMETERS="containsParameters",i._DEFAULT_SIZE=25,i._CONTAINSKEYS="containsKeys",i._FETCHBYKEYS="fetchByKeys",i._FETCHBYOFFSET="fetchByOffset",i._FETCHFIRST="fetchFirst",i._FETCHATTRIBUTES="attributes",e._registerLegacyNamespaceProp("DataCache",i);class a extends r.GenericEvent{constructor(t){let e={};e[a._DETAIL]=t,super("mutate",e)}}a._DETAIL="detail",e._registerLegacyNamespaceProp("DataProviderMutationEvent",a);class s extends r.GenericEvent{constructor(t){let e={};e.detail=t,super("refresh",e)}}e._registerLegacyNamespaceProp("DataProviderRefreshEvent",s);class n{fetchByKeys(t){let e=0,r=this.getIterationLimit?this.getIterationLimit():-1,i={size:25},a=new Map,s=this.fetchFirst(i)[Symbol.asyncIterator]();return function t(i,a,s){return a.next().then(function(n){let o=n.value,l=o.data,f=o.metadata,u=f.map(function(t){return t.key}),c=!0;return i.keys.forEach(function(t){s.has(t)||u.map(function(e,r){e==t&&s.set(e,{metadata:f[r],data:l[r]})}),s.has(t)||(c=!1)}),e+=l.length,c||n.done||-1!=r&&e>=r?s:t(i,a,s)})}(t,s,a).then(function(e){let r=new Map;return e.forEach(function(t,e){let i=[t];r.set(e,i[0])}),{fetchParameters:t,results:r}})}containsKeys(t){return this.fetchByKeys(t).then(function(e){let r=new Set;return t.keys.forEach(function(t){null!=e.results.get(t)&&r.add(t)}),Promise.resolve({containsParameters:t,results:r})})}getCapability(t){if("fetchByKeys"==t)return{implementation:"iteration"};let e=null;if(!0!==this._ojSkipLastCapability){this._ojSkipLastCapability=!0;let r=1;for(;this["_ojLastGetCapability"+r];)++r;for(--r;r>0&&(e=this["_ojLastGetCapability"+r](t),!e);r--);delete this._ojSkipLastCapability}return e}static applyMixin(t){let e=t.prototype.getCapability;if([n].forEach(e=>{Object.getOwnPropertyNames(e.prototype).forEach(r=>{"constructor"!==r&&(t.prototype[r]=e.prototype[r])})}),e){let r=1;for(;t.prototype["_ojLastGetCapability"+r];)++r;t.prototype["_ojLastGetCapability"+r]=e}}}e._registerLegacyNamespaceProp("FetchByKeysMixin",n);class o{fetchByOffset(t){let e=t&&t.size>0?t.size:25,r=t?t.sortCriteria:null,i=t&&t.offset>0?t.offset:0,a=0,s=this.getIterationLimit?this.getIterationLimit():-1,n=!1,o={};o.size=e,o.sortCriteria=r;let l=new Array,f=this.fetchFirst(o)[Symbol.asyncIterator]();return function t(r,o,l){return o.next().then(function(f){n=f.done;let u=f.value,c=u.data,h=u.metadata,p=c.length;if(i<a+p){for(let t=i<=a?0:i-a;t<p&&l.length!=e;t++)l.push({metadata:h[t],data:c[t]})}return a+=p,l.length<e&&!n?-1!=s&&a>=s?l:t(r,o,l):l})}(t,f,l).then(function(e){return{fetchParameters:t,results:e,done:n}})}getCapability(t){if("fetchByOffset"==t)return{implementation:"iteration"};let e=null;if(!0!==this._ojSkipLastCapability){this._ojSkipLastCapability=!0;let r=1;for(;this["_ojLastGetCapability"+r];)++r;for(--r;r>0&&(e=this["_ojLastGetCapability"+r](t),!e);r--);delete this._ojSkipLastCapability}return e}static applyMixin(t){let e=t.prototype.getCapability;if([o].forEach(e=>{Object.getOwnPropertyNames(e.prototype).forEach(r=>{"constructor"!==r&&(t.prototype[r]=e.prototype[r])})}),e){let r=1;for(;t.prototype["_ojLastGetCapability"+r];)++r;t.prototype["_ojLastGetCapability"+r]=e}}}var l;e._registerLegacyNamespaceProp("FetchByOffsetMixin",o),function(t){function e(t,e){var r=!1;for(var i in e)if(e.hasOwnProperty(i)){var s=e[i];if(r||!a(i))throw new Error("parsing error "+e);t.operator=i,t.right=s,r=!0}}function r(t,e,r){var i;if("$lt"===t)return(r=(i=n(r,e))[0])<(e=i[1]);if("$gt"===t)return(r=(i=n(r,e))[0])>(e=i[1]);if("$lte"===t)return(r=(i=n(r,e))[0])<=(e=i[1]);if("$gte"===t)return(r=(i=n(r,e))[0])>=(e=i[1]);if("$eq"===t)return r===e;if("$ne"===t)return r!==e;if("$regex"===t){if(r){if("string"!=typeof r&&!(r instanceof String))if(r instanceof Object){if("[object Object]"==(r=r.toString()))return!1}else r=new String(r);return null!==r.match(e)}return!1}if("$exists"===t)return e?null!=r:null==r;throw new Error("not a valid operator! "+t)}function i(t){return"$and"===t||"$or"===t}function a(t){return"$lt"===t||"$gt"===t||"$lte"===t||"$gte"===t||"$eq"===t||"$ne"===t||"$regex"===t||"$exists"===t}function s(t){return null!=t&&(t instanceof String||"string"==typeof t)}function n(t,e){return s(t)&&null==e?e="":s(e)&&null==t&&(t=""),[t,e]}function o(t,e){for(var r=t.split("."),i=e,a=0;a<r.length;a++)i=i[r[a]];return i}t.satisfy=function(t,s){return!t||function t(e,s){var n=e.operator;if(i(n)){if(!e.left&&e.array instanceof Array){for(var l,f=e.array,u=0;u<f.length;u++){var c=t(f[u],s);if("$or"===n&&!0===c)return!0;if("$and"===n&&!1===c)return!1;l=c}return l}throw new Error("invalid expression tree!"+e)}if(a(n)){var h,p=e.right;if("*"!=e.left)return h=o(e.left,s),r(n,p,h);var _,m=Object.keys(s);for(_=0;_<m.length;_++)if(h=o(m[_],s),r(n,p,h))return!0;return!1}throw new Error("not a valid expression!"+e)}(function t(r){var s,n=[];for(var o in r)if(r.hasOwnProperty(o)){var l=r[o];if(0===o.indexOf("$")){if(i(o)){if(!(l instanceof Array))throw new Error("not a valid expression: "+r);s={operator:o,array:[]};for(var f=0;f<l.length;f++){var u=t(l[f]);s.array.push(u)}}else if(a(o))throw new Error("not a valid expression: "+r)}else if("object"!=typeof l)n.push({left:o,right:l,operator:"$eq"});else{var c={left:o};e(c,l),n.push(c)}}n.length>1?s={operator:"$and",array:n}:1===n.length&&(s=n[0]);return s}(t),s)}}(l||(l={}));class f{constructor(t){t=t||{},this._textFilterAttributes=t.filterOptions?t.filterOptions.textFilterAttributes:null;let e=t.filterDef;e&&(e.op?(this.op=e.op,e.value?(this.value=e.value,e.attribute&&(this.attribute=e.attribute)):e.criteria&&(this.criteria=e.criteria)):e.text&&(this.text=e.text))}filter(t,e,r){return l.satisfy(f._transformFilter(this),t)}static _transformFilter(t){let e;if(t){let r,i=t.op;if(t.text?i="$regex":"$le"===i?i="$lte":"$ge"===i?i="$gte":"$pr"===i&&(i="$exists"),"$and"!=i&&"$or"!=i){r=t.text?new RegExp(t.text.replace(/[.*+\-?^${}()|[\]\\]/g,"\\$&"),"i"):t.value,e={};let a=t.attribute;if(a){let t={};"$sw"!==i&&"$ew"!==i&&"$co"!==i||(i="$regex",r=f._fixStringExpr(i,r)),t[i]=r,e[a]=t}else if(t.text){let a={};if(a[i]=r,t._textFilterAttributes&&t._textFilterAttributes.length>0){let r=[];t._textFilterAttributes.forEach(function(t){let e={};e[t]=a,r.push(e)}),e.$or=r}else e["*"]=a}else{let t=[];f._transformObjectExpr(r,i,null,t),e.$and=t}}else{let r=[];t.criteria.forEach(function(e){e&&e.text&&t._textFilterAttributes&&(e._textFilterAttributes=t._textFilterAttributes),r.push(f._transformFilter(e))}),e={},e[i]=r}}return e}static _transformObjectExpr(t,e,r,i){if(Object.keys(t).length>0)Object.keys(t).forEach(function(a){let s=t[a],n=r?r+"."+a:a;if(s instanceof Object)f._transformObjectExpr(s,e,n,i);else{let t={};"$sw"!==e&&"$ew"!==e&&"$co"!==e||(e="$regex",s=f._fixStringExpr(e,s)),t[e]=s;let r={};r[n]=t,i.push(r)}});else{let a={};a[e]=t;let s={};s[r]=a,i.push(s)}}static _fixStringExpr(t,e){return("string"==typeof e||e instanceof String)&&("$sw"===t?e="^"+e:"$ew"===t&&(e+="$")),e}}class u{static getFilter(t){return new f(t)}}e._registerLegacyNamespaceProp("FilterFactory",u),t.DataCache=i,t.DataProviderMutationEvent=a,t.DataProviderRefreshEvent=s,t.FetchByKeysMixin=n,t.FetchByOffsetMixin=o,t.FilterFactory=u,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=ojdataprovider.js.map
/**
 * @license
 * Copyright (c) 2014, 2021, Oracle and/or its affiliates.
 * Licensed under The Universal Permissive License (UPL), Version 1.0
 * as shown at https://oss.oracle.com/licenses/upl/
 * @ignore
 */
define(["ojs/ojcore-base","ojs/ojset","ojs/ojeventtarget","ojs/ojkeyset","ojs/ojobservable","ojs/ojmap"],function(e,t,a,r,s,i){"use strict";e=e&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e,t=t&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t,i=i&&Object.prototype.hasOwnProperty.call(i,"default")?i.default:i;
/**
     * @license
     * Copyright (c) 2014, 2021, Oracle and/or its affiliates.
     * The Universal Permissive License (UPL), Version 1.0
     * as shown at https://oss.oracle.com/licenses/upl/
     * @ignore
     */
/**
     * @preserve Copyright 2013 jQuery Foundation and other contributors
     * Released under the MIT license.
     * http://jquery.org/license
     */
class n{constructor(e,t){this.dataProvider=e,this.options=t,this._DATAPROVIDER="dataprovider",this._EXPANDED="expanded",this._KEY="key",this._PARENTKEY="parentKey",this._INDEXFROMPARENT="indexFromParent",this._TREEDEPTH="treeDepth",this._ISLEAF="isLeaf",this._KEYS="keys",this._OFFSET="offset",this._SIZE="size",this._DONE="done",this._VALUE="value",this._DATA="data",this._REFRESH="refresh",this._MUTATE="mutate",this._SORTCRITERIA="sortCriteria",this._FILTERCRITERION="filterCriterion",this._ATTRIBUTES="attributes",this._METADATA="metadata",this._RESULTS="results",this._FETCHPARAMETERS="fetchParameters",this._CONTAINSPARAMETERS="containsParameters",this._CONTAINSKEYS="containsKeys",this._FETCHBYKEYS="fetchByKeys",this._FETCHBYOFFSET="fetchByOffset",this._AFTERKEYS="afterKeys",this._ADDBEFOREKEYS="addBeforeKeys",this._ADD="add",this._REMOVE="remove",this._UPDATE="update",this._INDEXES="indexes",this._ADDEVENTLISTENER="addEventListener",this.AsyncIterable=class{constructor(e,t){this._parent=e,this._asyncIterator=t,this[Symbol.asyncIterator]=function(){return this._asyncIterator}}},this.AsyncIterator=class{constructor(e,t,a){this._parent=e,this._nextFunc=t,this._params=a}next(){let e=this._nextFunc(this._params);return Promise.resolve(e)}},this.AsyncIteratorYieldResult=class{constructor(e,t){this._parent=e,this.value=t,this[e._VALUE]=t,this[e._DONE]=!1}},this.AsyncIteratorReturnResult=class{constructor(e,t){this._parent=e,this.value=t,this[e._VALUE]=t,this[e._DONE]=!0}},this.Item=class{constructor(e,t,a){this._parent=e,this.metadata=t,this.data=a,this[e._METADATA]=t,this[e._DATA]=a}},this.FlattenedTreeItemMetadata=class{constructor(e,t,a,r,s,i){this._parent=e,this.key=t,this.parentKey=a,this.indexFromParent=r,this.treeDepth=s,this.isLeaf=i,this[e._KEY]=t,this[e._PARENTKEY]=a,this[e._INDEXFROMPARENT]=r,this[e._TREEDEPTH]=s,this[e._ISLEAF]=i}},this.FetchListParameters=class{constructor(e,t,a,r){this._parent=e,this.size=t,this.sortCriteria=a,this.filterCriterion=r,this[e._SIZE]=t,this[e._SORTCRITERIA]=a,this[e._FILTERCRITERION]=r}},this.FetchListResult=class{constructor(e,t,a,r){this._parent=e,this.fetchParameters=t,this.data=a,this.metadata=r,this[e._FETCHPARAMETERS]=t,this[e._DATA]=a,this[e._METADATA]=r}},this.FetchByOffsetParameters=class{constructor(e,t,a,r,s,i){this._parent=e,this.offset=t,this.size=a,this.sortCriteria=r,this.filterCriterion=s,this.attributes=i,this[e._OFFSET]=t,this[e._SIZE]=a,this[e._SORTCRITERIA]=r,this[e._FILTERCRITERION]=s,this[e._ATTRIBUTES]=i}},this.FetchByOffsetResults=class{constructor(e,t,a,r){this._parent=e,this.fetchParameters=t,this.results=a,this.done=r,this[e._FETCHPARAMETERS]=t,this[e._RESULTS]=a,this[e._DONE]=r}},this.FetchByKeysResults=class{constructor(e,t,a){this._parent=e,this.fetchParameters=t,this.results=a,this[e._FETCHPARAMETERS]=t,this[e._RESULTS]=a}},this.ContainsKeysResults=class{constructor(e,t,a){this._parent=e,this.containsParameters=t,this.results=a,this[e._CONTAINSPARAMETERS]=t,this[e._RESULTS]=a}},this.DataProviderMutationEventDetail=class{constructor(e,t,a,r){this._parent=e,this.add=t,this.remove=a,this.update=r,this[e._ADD]=t,this[e._REMOVE]=a,this[e._UPDATE]=r}},this.DataProviderRefreshEventDetail=class{constructor(e){this.disregardAfterKey=e,this.disregardAfterKey=e}},this.DataProviderOperationEventDetail=class{constructor(e,t,a,r,s){this._parent=e,this.keys=t,this.metadata=a,this.data=r,this.indexes=s,this[e._KEYS]=t,this[e._METADATA]=a,this[e._DATA]=r,this[e._INDEXES]=s}},this.DataProviderAddOperationEventDetail=class{constructor(e,t,a,r,s,i,n){this._parent=e,this.keys=t,this.afterKeys=a,this.addBeforeKeys=r,this.metadata=s,this.data=i,this.indexes=n,this[e._KEYS]=t,this[e._AFTERKEYS]=a,this[e._ADDBEFOREKEYS]=r,this[e._METADATA]=s,this[e._DATA]=i,this[e._INDEXES]=n}};let a=this;null==a.options&&(a.options={}),a.options.expanded||(a.options.expanded=new r.ExpandedKeySet([])),a._expandedObservable=new s.BehaviorSubject(a._getExpandedObservableValue(a.options.expanded,Promise.resolve())),a.dataProvider.addEventListener("mutate",a._handleUnderlyingMutation.bind(a)),a.dataProvider.addEventListener("refresh",a._handleUnderlyingRefresh.bind(a)),a._cache=[],a._iterators=new i,a._done=!1}_handleUnderlyingMutation(t){let a=this,r=null,s=null,i=null,n=t.detail.add;if(n&&n.data&&n.data.length){let e=[],t=[],s=[],i=[],h=[],d=new Set,l=new Set;n.parentKeys.forEach(function(r,o){if(null===r||a._isExpanded(r)&&a._getItemByKey(r)){let c;if(null!=n.addBeforeKeys){c=a._getItemIndexByKey(n.addBeforeKeys[o])-1}else if(null!=n.indexes){let e=a._getItemIndexByKey(r);c=-1===e?n.indexes[o]:e+n.indexes[o]}else c=a._getItemIndexByKey(a._getLastItemByParentKey(r).metadata.key)+1;let _=a._updateItemMetadata(new a.Item(a,n.metadata[o],n.data[o]),r,n.indexes[o]);a._spliceItemToCache(_,c),t.push(_.data),e.push(_.metadata),s.push(c),i.push(n.addBeforeKeys[o]),h.push(r),d.add(n.addBeforeKeys[o]),l.add(n.metadata[o].key),a._incrementIteratorOffset(c)}}),r=new a.DataProviderAddOperationEventDetail(a,l,d,i,e,t,s)}let h=t.detail.remove;if(h&&h.data&&h.data.length){let e=h.metadata.map(function(e){return e.key}),t=[],r=[],i=[],n=new Set;e.forEach(function(e){let s=a._getLocalDescendentCount(e)+1,h=a._getItemIndexByKey(e);a._cache.splice(h,s).forEach(function(e,s){n.add(e.metadata.key),t.push(e.metadata),r.push(e.data),i.push(h+s),a._decrementIteratorOffset(h)})}),s=new a.DataProviderOperationEventDetail(a,n,t,r,i)}let d=t.detail.update;if(d&&d.data&&d.data.length){let e=[],t=[],r=[],s=new Set;d.metadata.forEach(function(i,n){let h=a._getItemByKey(i.key);if(null!=h){let c=a._getItemIndexByKey(i.key);var l=d.data[n],o=new a.FlattenedTreeItemMetadata(a,h.metadata.key,h.metadata.parentKey,h.metadata.indexFromParent,h.metadata.treeDepth,null===a.getChildDataProvider(h.metadata.key));a._cache.splice(c,1,new a.Item(a,o,l)),s.add(h.metadata.key),e.push(h.metadata),t.push(h.data),r.push(c)}}),i=new a.DataProviderOperationEventDetail(a,s,e,t,r)}let l=new a.DataProviderMutationEventDetail(a,r,s,i);a.dispatchEvent(new e.DataProviderMutationEvent(l))}_handleUnderlyingRefresh(){this._clearCache(),this.dispatchEvent(new e.DataProviderRefreshEvent)}_getExpandedObservableValue(e,t){return{value:e,completionPromise:t}}getChildDataProvider(e,t){return this.dataProvider.getChildDataProvider(e,t)}containsKeys(e){return this.dataProvider.containsKeys(e)}fetchByKeys(e){var t=this;return this.dataProvider.fetchByKeys(e).then(function(e){let a=new i;return e.results.forEach(function(e,r){let s=t._getItemByKey(r);s?a.set(r,s):a.set(r,e)}),new t.FetchByKeysResults(t,e.fetchParameters,a)})}fetchByOffset(e){let t=this,a=null!=e?e[this._SIZE]:-1,r=null!=e?e[this._SORTCRITERIA]:null,s=null!=e&&e[this._OFFSET]>0?e[this._OFFSET]:0,i=null!=e?e[this._FILTERCRITERION]:null,n=null!=e?e[this._ATTRIBUTES]:null;if(e=new t.FetchByOffsetParameters(t,s,a,r,i,n),t._isSameCriteria(r,i)){if(t._checkCacheByOffset(e))return new Promise(function(a){a(t._getFetchByOffsetResultsFromCache(e))})}else t._clearCache(),t._currentSortCriteria=r,t._currentFilterCriteria=i;return t._fetchByOffset(e)}fetchFirst(e){let t=this;t._fetchSize=null!=e?e[this._SIZE]:-1;let a=null!=e?e[this._SORTCRITERIA]:null,r=null!=e?e[this._FILTERCRITERION]:null,s=null!=e?e[this._ATTRIBUTES]:null;t._isSameCriteria(a,r)||(t._currentSortCriteria=a,t._currentFilterCriteria=r,t._clearCache());let i=new t.AsyncIterable(t,new t.AsyncIterator(t,function(){let e=t._iterators.get(i),n=new t.FetchByOffsetParameters(t,e,t._fetchSize,a,r,s);return t.fetchByOffset(n).then(function(a){let r=a.results,s=r.map(function(e){return e[t._DATA]}),h=r.map(function(e){return e[t._METADATA]}),d=0===s.length||a[t._DONE];return t._iterators.set(i,e+h.length),d?Promise.resolve(new t.AsyncIteratorReturnResult(t,new t.FetchListResult(t,n,s,h))):Promise.resolve(new t.AsyncIteratorYieldResult(t,new t.FetchListResult(t,n,s,h)))})},e));return t._iterators.set(i,0),i}getCapability(e){return this.dataProvider.getCapability(e)}getTotalSize(){return Promise.resolve(-1)}isEmpty(){return this.dataProvider.isEmpty()}_isSameCriteria(e,t){if(e){if(!this._currentSortCriteria||e[0].attribute!=this._currentSortCriteria[0].attribute||e[0].direction!=this._currentSortCriteria[0].direction)return!1}else if(this._currentSortCriteria)return!1;if(t){if(!this._currentFilterCriteria||t[0].op!=this._currentFilterCriteria[0].op||t[0].filter!=this._currentFilterCriteria[0].filter)return!1}else if(this._currentFilterCriteria)return!1;return!0}_checkCacheByOffset(e,t){if(-1===e[this._SIZE]&&!0===this._done)return!0;if(null!=t){if(this._getLocalDescendentCount(t)>=e[this._SIZE]&&-1!==e[this._SIZE])return!0}else if(this._cache.length>=e[this._OFFSET]+e[this._SIZE]&&-1!==e[this._SIZE])return!0;return!1}_getFetchByOffsetResultsFromCache(e){let t=this._cache.slice(e[this._OFFSET],-1===e[this._SIZE]?void 0:e[this._OFFSET]+e[this._SIZE]),a=!1;return 0==t.length&&(this._lastParams&&this._lastParams==e?a=!0:this._lastParams=e),new this.FetchByOffsetResults(this,e,t,a)}_clearCache(){this._cache=[]}_fetchByOffset(e){let t=this;if(0===t._cache.length){let a=-1===e[t._SIZE]?-1:e[t._OFFSET]+e[t._SIZE],r=new this.FetchByOffsetParameters(t,0,a,e[t._SORTCRITERIA],e[t._FILTERCRITERION],e[t._ATTRIBUTES]);return t._fetchChildrenByOffsetFromDataProvider(r,t.dataProvider,null,e)}let a=t._getLastEntry(),r=a.metadata.key,s=0;!a.metadata.isLeaf&&t._isExpanded(r)||(r=a.metadata.parentKey,s=a.metadata.indexFromParent+1);let i=null===r?t.dataProvider:t.getChildDataProvider(r),n=t._getRemainingSize(e),h=new this.FetchByOffsetParameters(t,s,n,e[t._SORTCRITERIA],e[t._FILTERCRITERION],e[t._ATTRIBUTES]);return t._fetchChildrenByOffsetFromAncestors(h,i,r,e)}_fetchChildrenByOffsetFromAncestors(e,t,a,r,s){let i=this,n=function(t,a){let h=i._getItemByKey(t);if(i._checkCacheByOffset(r,s)||a[i._DONE]&&null===t||null===h)return Promise.resolve();let d=h.metadata.parentKey,l=h.metadata.indexFromParent,o=null===d?i.dataProvider:i.getChildDataProvider(d),c=new i.FetchByOffsetParameters(i,l+1,i._getRemainingSize(r),e[i._SORTCRITERIA],e[i._FILTERCRITERION],e[i._ATTRIBUTES]);return i._fetchChildrenByOffsetFromDataProvider(c,o,d,r,s).then(n.bind(i,d))};return i._fetchChildrenByOffsetFromDataProvider(e,t,a,r,s).then(n.bind(i,a)).then(i._getFetchByOffsetResultsFromCache.bind(i,r))}_fetchChildrenByOffsetFromDataProvider(e,t,a,r,s){let i=this,n=function(t){let h=t.results;if(0===h.length||i._checkCacheByOffset(r,s))return Promise.resolve();let d=h.shift(),l=i._updateItemMetadata(d,a);if(i._pushItemToCache(l,a),i._isExpanded(l.metadata.key)){let t=i.getChildDataProvider(l.metadata.key);if(null!=t){let a=new i.FetchByOffsetParameters(i,0,i._getRemainingSize(r),e[i._SORTCRITERIA],e[i._FILTERCRITERION],e[i._ATTRIBUTES]);return i._fetchChildrenByOffsetFromDataProvider(a,t,l.metadata.key,r,s).then(n.bind(i,new i.FetchByOffsetResults(i,e,h,!1)))}}return n(new i.FetchByOffsetResults(i,e,h,!1))};return t.fetchByOffset(e).then(n).then(i._getFetchByOffsetResultsFromCache.bind(i,r))}_sequence(e,t){return e.reduce((e,a)=>e.then(()=>t(a)),Promise.resolve())}_getRemainingSize(e){return-1===e[this._SIZE]?-1:e[this._SIZE]+e[this._OFFSET]-this._cache.length}_getExpandedKeysFromResults(e){let t=this;return e.map(function(e){return e.metadata.key}).filter(function(e){return t._isExpanded(e)})}_isExpanded(e){return this.options[this._EXPANDED].has(e)}setExpanded(t){let a=this,r=a.createOptimizedKeySet(),s=a.createOptimizedKeySet();a._oldExpanded=a.options.expanded,a.options.expanded=t;let i=a._oldExpanded,n=a.options.expanded;if(n.isAddAll()||i.isAddAll()){if(!n.isAddAll()||!i.isAddAll())return a._clearCache(),a.dispatchEvent(new e.DataProviderRefreshEvent),void a.getExpandedObservable().next(a._getExpandedObservableValue(this.options.expanded,Promise.resolve()));var h=n.deletedValues(),d=i.deletedValues();h.forEach(function(e){i.has(e)&&s.add(e)}),d.forEach(function(e){n.has(e)&&r.add(e)})}else{let e=n.values(),t=i.values();e.forEach(function(e){i.has(e)||r.add(e)}),t.forEach(function(e){n.has(e)||s.add(e)})}const l=a._expand(r),o=a._collapse(s),c=new Promise(function(t){l.then(r=>{const s=r.operationAddEventDetail,i=r.fetchedCountMap;let n=null,h=null;if(-1!==a._fetchSize&&i.forEach((e,t)=>{if(e>=a._fetchSize){const e=a._getItemIndexByKey(t);(e<h||null===h)&&(h=e,n=t)}}),null!==h){a._cache.splice(h+1,a._cache.length).forEach(()=>{a._decrementIteratorOffset(h+1)})}if(null===n){const t=new a.DataProviderMutationEventDetail(a,s,o,null);a.dispatchEvent(new e.DataProviderMutationEvent(t))}if(null!==n){const t=new e.DataProviderRefreshEvent(new a.DataProviderRefreshEventDetail(n));a.dispatchEvent(t)}t()})});a.getExpandedObservable().next(a._getExpandedObservableValue(this.options.expanded,c))}getExpandedObservable(){return this._expandedObservable}_isExpandAll(){return this.options[this._EXPANDED].isAddAll()}_pushItemToCache(e,t){let a=this._getLastItemByParentKey(t),r=null==a?this._getItemIndexByKey(t):this._getItemIndexByKey(a.metadata.key)+this._getLocalDescendentCount(a.metadata.key);this._cache.splice(r+1,0,e)}_spliceItemToCache(e,t){this._cache.splice(t+1,0,e)}_updateItemMetadata(e,t,a){let r=0,s=this._getLastItemByParentKey(t),i=null==s?0:s.metadata[this._INDEXFROMPARENT]+1;if(null!=a&&(i=a),null!=t){r=this._getItemByKey(t).metadata.treeDepth+1}return new this.Item(this,new this.FlattenedTreeItemMetadata(this,e.metadata.key,t,i,r,null===this.getChildDataProvider(e.metadata.key)),e.data)}_getItemByKey(e){var t=null;return this._cache.some(function(a){if(a.metadata.key===e)return t=a,!0}),t}_getItemIndexByKey(e){var t=-1;return this._cache.some(function(a,r){if(a.metadata.key===e)return t=r,!0}),t}_getLastEntry(){return this._cache[this._getLastIndex()]}_getEntry(e){return this._cache[e]}_getLastItemByParentKey(e){var t=null;return this._cache.slice().reverse().some(function(a){if(a.metadata.parentKey===e)return t=a,!0}),t}_getLastIndex(){return this._cache.length-1}_getLocalDescendentCount(e){let t=this,a=t._getItemByKey(e),r=0;if(null!=a){let s=t._getItemIndexByKey(e),i=a.metadata.treeDepth,n=t._getLastIndex();for(let e=s+1;e<=n;e++){if(!(t._getEntry(e).metadata.treeDepth>i))return r;r+=1}}return r}_expand(e){let t=[],a=this;return e.forEach(function(e){let r=new a.FetchByOffsetParameters(a,0,a._fetchSize,a._currentSortCriteria,a._currentFilterCriteria,null),s=a.getChildDataProvider(e);t.push(a._fetchChildrenByOffsetFromDataProvider(r,s,e,r,e))}),Promise.all(t).then(function(){let t=a.createOptimizedKeySet(),r=a.createOptimizedKeySet(),s=[],i=[],n=[],h=new Map;return e.forEach(function(e){let d=a._getLocalDescendentCount(e);if(d>0){h.set(e,d);let l=a._getItemIndexByKey(e)+1,o=null;a._cache.slice(l,l+d).forEach(function(e,h){t.add(e.metadata.key),r.add(o),s.push(e.metadata),i.push(e.data),n.push(l+h),o=e.metadata.key,a._incrementIteratorOffset(l)})}}),{operationAddEventDetail:new a.DataProviderAddOperationEventDetail(a,t,r,[],s,i,n),fetchedCountMap:h}})}_collapse(e){let t=this,a=[],r=[],s=[],i=t.createOptimizedKeySet();return e.forEach(function(e){let n=t._getLocalDescendentCount(e);if(n>0){let h=t._getItemIndexByKey(e);t._cache.splice(h+1,n).forEach(function(e,n){i.add(e.metadata.key),a.push(e.metadata),r.push(e.data),s.push(h+n+1),t._decrementIteratorOffset(h+1)})}}),new t.DataProviderOperationEventDetail(t,i,a,r,s)}_decrementIteratorOffset(e){var t=this;t._iterators.forEach(function(a,r){e<a&&t._iterators.set(r,a-1)})}_incrementIteratorOffset(e){var t=this;t._iterators.forEach(function(a,r){e<a&&t._iterators.set(r,a+1)})}createOptimizedKeySet(e){return this.dataProvider.createOptimizedKeySet?this.dataProvider.createOptimizedKeySet(e):new t(e)}createOptimizedKeyMap(e){if(this.dataProvider.createOptimizedKeyMap)return this.dataProvider.createOptimizedKeyMap(e);if(e){let t=new i;return e.forEach(function(e,a){t.set(a,e)}),t}return new i}}return e._registerLegacyNamespaceProp("FlattenedTreeDataProviderView",n),e.EventTargetMixin.applyMixin(n),n});
//# sourceMappingURL=ojflattenedtreedataproviderview.js.map
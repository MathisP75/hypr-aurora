!function(){function e(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function t(e,t){for(var a=0;a<t.length;a++){var n=t[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function a(e,a,n){return a&&t(e.prototype,a),n&&t(e,n),e}
/**
 * @license
 * Copyright (c) 2014, 2021, Oracle and/or its affiliates.
 * Licensed under The Universal Permissive License (UPL), Version 1.0
 * as shown at https://oss.oracle.com/licenses/upl/
 * @ignore
 */define(["ojs/ojlogger"],function(t){"use strict";var n,s,i,r=function(){function t(a,n,s){e(this,t),this.asyncIterator=a,this.cache=n,this.cacheEntries=s}return a(t,[{key:"next",value:function(){var e=this,t=this.asyncIterator.next();return t.then(function(t){var a=t.value,n=e.cache.data.length,i=n+a.data.length-1;e.cache.data=e.cache.data.concat(a.data),e.cache.metadata=e.cache.metadata.concat(a.metadata),e.cache.done=t.done,e.cacheEntries.push({start:n,end:i,miss:0,status:s.READY})}),t}}]),t}(),c=function t(a,n,s){var i=this;e(this,t),this.asyncIterable=a,this.cache=n,this.cacheEntries=s,this[Symbol.asyncIterator]=function(){return new r(i.asyncIterable[Symbol.asyncIterator](),i.cache,i.cacheEntries)}};return function(e){e[e.NEVER=0]="NEVER",e[e.LRU=1]="LRU"}(n||(n={})),function(e){e[e.READY=0]="READY",e[e.FETCHING=1]="FETCHING",e[e.PURGED=2]="PURGED"}(s||(s={})),function(e){e[e.UP=0]="UP",e[e.DOWN=1]="DOWN"}(i||(i={})),function(){function r(t,a,s){e(this,r),this.dataProvider=t,this.cache=a,this.options=s,this.strategy=n.NEVER,this.prefetching=!1,this.currentStart=0,this.CACHE_MISS_THRESHOLD=5,null==a&&(this.cache={data:[],metadata:[],done:!1,startIndex:0}),this.cacheQueue=[],this.modelEventHandler=this._handleModelEvent.bind(this),t.addEventListener("mutate",this.modelEventHandler),t.addEventListener("refresh",this.modelEventHandler)}return a(r,[{key:"destroy",value:function(){this.dataProvider&&this.modelEventHandler&&(this.dataProvider.removeEventListener("mutate",this.modelEventHandler),this.dataProvider.removeEventListener("refresh",this.modelEventHandler))}},{key:"fetchFirst",value:function(e){this._resetCache();var t=this.dataProvider.fetchFirst(e);return new c(t,this.cache,this.cacheQueue)}},{key:"fetchByKeys",value:function(e){return this.dataProvider.fetchByKeys(e)}},{key:"containsKeys",value:function(e){return this.dataProvider.containsKeys(e)}},{key:"fetchByOffset",value:function(e){var a=this;void 0===this.proximity&&(this.proximity=e.size);var n=i.UP,r=e.offset,c=r+e.size;if(r>this.currentStart&&(n=i.DOWN),this.currentStart=r,!this._isInCache(r,c))return t.info("Cache missed: "+r+" - "+c),this.cacheQueue.forEach(function(e){e.status!==s.FETCHING&&(e.start>=r&&e.start<=c||e.end<=c&&e.end>=r?(a._log("cache entry update to FETCHING - start: "+e.start+" end: "+e.end),e.status=s.FETCHING):e.miss=e.miss+1)}),this.fetchByOffsetPromise=new Promise(function(t,i){a._log("Call fetchByOffset to fulfill cache"),a.dataProvider.fetchByOffset(e).then(function(i){for(var h=0;h<i.results.length;h++){var u=i.results[h];a.cache.data[r+h]=u.data,a.cache.metadata[r+h]=u.metadata}a._log("cache fulfilled - offset: "+r+" size: "+i.results.length),a.cacheQueue.forEach(function(e){e.status===s.FETCHING&&(a._log("cache entry update to READY - start: "+e.start+" end: "+e.end),e.status=s.READY,e.miss=0)});var d=a._getFetchByOffsetResult(r,c);t({results:d,fetchParameters:e,done:!1}),a._recalibrateCache(r,c,n)})}),this.fetchByOffsetPromise;this._updateCacheEntries(r,c);var h=this._getFetchByOffsetResult(r,c);return this._recalibrateCache(r,c,n),Promise.resolve({results:h,fetchParameters:e,done:!1})}},{key:"_updateCacheEntries",value:function(e,t){this.cacheQueue.forEach(function(a){a.status!==s.PURGED&&(a.start>t||a.end<e?a.miss=a.miss+1:a.miss=0)})}},{key:"_getFetchByOffsetResult",value:function(e,t){for(var a=e-this.cache.startIndex,n=t-this.cache.startIndex,s=[],i=a;i<n;i++)s.push({data:this.cache.data[i],metadata:this.cache.metadata[i]});return s}},{key:"getTotalSize",value:function(){return this.dataProvider.getTotalSize()}},{key:"isEmpty",value:function(){return this.dataProvider.isEmpty()}},{key:"getCapability",value:function(e){return this.dataProvider.getCapability(e)}},{key:"addEventListener",value:function(e,t){this.dataProvider.addEventListener(e,t)}},{key:"removeEventListener",value:function(e,t){this.dataProvider.removeEventListener(e,t)}},{key:"dispatchEvent",value:function(e){return this.dataProvider.dispatchEvent(e)}},{key:"_handleModelEvent",value:function(e){if("refresh"===e.type)this._handleRowsRefreshed();else if("mutate"===e.type){var t=e.detail;t.add&&this._handleRowsAdded(t.add),t.remove&&this._handleRowsRemoved(t.remove),t.update&&this._handleRowsUpdated(t.update)}}},{key:"_resetCache",value:function(){this.cache.data.length=0,this.cache.metadata.length=0,this.cache.startIndex=0,this.cache.done=!1,this.cacheQueue.length=0}},{key:"_recalibrateCache",value:function(e,t,a){var r=this;if(this.strategy!==n.NEVER&&(this.cacheQueue.forEach(function(a){if(a.status===s.READY&&a.miss>=r.CACHE_MISS_THRESHOLD&&(a.end<e-r.proximity||a.start>t+r.proximity)){r._log("Purging cache range: "+a.start+" to "+a.end);for(var n=a.start;n<=a.end;n++)r.cache.data[n]=null,r.cache.metadata[n]=null;a.status=s.PURGED}}),this._dumpCacheStatus(),!1!==this.prefetching))for(var c=function(n){var c=r.cacheQueue[n];return a===i.UP&&c.start<e&&c.end>e?(c.status!==s.PURGED&&r._isInCache(c.start,c.end)||(c.status=s.FETCHING,r._log("pre-fetch cache range (before adjustment): "+c.start+" - "+c.end+" direction: "+a),r._prefetchRange(c.start,e-c.start).then(function(e){c.status=s.READY})),"break"):a===i.DOWN&&c.start<t&&c.end>t?(c.status!==s.PURGED&&r._isInCache(c.start,c.end)||(c.status=s.FETCHING,r._log("pre-fetch cache range (before adjustment): "+c.start+" - "+c.end+" direction: "+a),r._prefetchRange(t,c.end-t).then(function(e){c.status=s.READY})),"break"):void 0},h=0;h<this.cacheQueue.length;h++){if("break"===c(h))break}}},{key:"_prefetchRange",value:function(e,t){var a=this;return this._log("pre-fetching to refill cache - offset: "+e+" size: "+t),new Promise(function(n,s){a.dataProvider.fetchByOffset({offset:e,size:t}).then(function(s){for(var i=0;i<s.results.length;i++){var r=s.results[i];a.cache.data[e+i]=r.data,a.cache.metadata[e+i]=r.metadata}a._log("pre-fetch result returned and cache is fulfilled - offset: "+e+" size: "+t),n(!0)})})}},{key:"_isInCache",value:function(e,t){if(this.strategy===n.NEVER)return!0;if(e<this.cache.startIndex||t>this.cache.startIndex+this.cache.data.length)return!1;for(var a=e-this.cache.startIndex,s=t-this.cache.startIndex,i=a;i<s;i++)if(null==this.cache.data[i])return!1;return!0}},{key:"_handleRowsMutated",value:function(e,t,a,n){var s=this,i=e.indexes;if(null==i)e[t];else i.forEach(function(t,i){if(t<s.cache.startIndex+s.cache.data.length)if(t>=s.cache.startIndex){var r=null!=e.data?e.data[i]:null,c=null!=e.metadata?e.metadata[i]:null;a(t,r,c)}else n&&n()})}},{key:"_handleRowsAdded",value:function(e){var t=this;this._log("handling add mutation event"),this._handleRowsMutated(e,"addBeforeKeys",function(e,a,n){t.cache.data.splice(e,0,a),t.cache.metadata.splice(e,0,n)},function(){t.cache.startIndex++})}},{key:"_handleRowsRemoved",value:function(e){var t=this;this._log("handling remove mutation event"),this._handleRowsMutated(e,"keys",function(e){t.cache.data.splice(e,1),t.cache.metadata.splice(e,1)},function(){t.cache.startIndex=Math.max(0,t.cache.startIndex-1)})}},{key:"_handleRowsUpdated",value:function(e){var t=this;this._log("handling update mutation event"),this._handleRowsMutated(e,"keys",function(e,a,n){t.cache.data.splice(e,1,a),t.cache.metadata.splice(e,1,n)})}},{key:"_handleRowsRefreshed",value:function(){this._log("handling refresh event"),this._resetCache()}},{key:"_log",value:function(e){t.info("[CachingDataProvider]=> "+e)}},{key:"_getStatusText",value:function(e){switch(e){case s.READY:return"ready";case s.FETCHING:return"fetching";case s.PURGED:return"purged";default:return"unknown"}}},{key:"_dumpCacheStatus",value:function(){var e=this;this.cacheQueue.forEach(function(t){e._log("Cache entry - start: "+t.start+" end: "+t.end+" miss: "+t.miss+" status: "+e._getStatusText(t.status))})}}]),r}()})}();
//# sourceMappingURL=ojcachingdataprovider.js.map
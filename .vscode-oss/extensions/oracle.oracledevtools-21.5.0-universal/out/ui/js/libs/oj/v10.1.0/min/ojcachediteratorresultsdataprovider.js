/**
 * @license
 * Copyright (c) 2014, 2021, Oracle and/or its affiliates.
 * Licensed under The Universal Permissive License (UPL), Version 1.0
 * as shown at https://oss.oracle.com/licenses/upl/
 * @ignore
 */
define(["ojs/ojcore-base","ojs/ojeventtarget","ojs/ojcomponentcore","ojs/ojdataprovider"],function(t,e,s,a){"use strict";t=t&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t;
/**
     * @license
     * Copyright (c) 2014, 2021, Oracle and/or its affiliates.
     * The Universal Permissive License (UPL), Version 1.0
     * @ignore
     */
/**
     * @preserve Copyright 2013 jQuery Foundation and other contributors
     * Released under the MIT license.
     * http://jquery.org/license
     */
class r{constructor(e){this.dataProvider=e,this.CacheAsyncIterable=class{constructor(t,e,s){this._parent=t,this.dataProviderAsyncIterator=e,this.cache=s,this[Symbol.asyncIterator]=()=>new this._parent.CacheAsyncIterator(this._parent,this.dataProviderAsyncIterator,this.cache)}},this.CacheAsyncIterator=class{constructor(t,e,s){this._parent=t,this.asyncIterator=e,this.cache=s,this._cachedOffset=0,this._iteratedOffset=0}next(){let t,e=this,s=this._parent._lastFetchParams,a=s.size?s.size:-1;if(-1==a){if(this.cache.isDone())return t=this.cache.getDataList(s,this._cachedOffset),this._cachedOffset=this._cachedOffset+t.data.length,Promise.resolve(new this._parent.CacheAsyncIteratorReturnResult(t))}else{if(this.cache.getSize()>=this._cachedOffset+a||this.cache.isDone())return t=this.cache.getDataList(s,this._cachedOffset),this._cachedOffset=this._cachedOffset+t.data.length,this._cachedOffset<this.cache.getSize()||!this.cache.isDone()?Promise.resolve(new this._parent.CacheAsyncIteratorYieldResult(t)):Promise.resolve(new this._parent.CacheAsyncIteratorReturnResult(t));if(this._cachedOffset>0)return new Promise(function(t,s){if(e._iteratedOffset<e._cachedOffset){let s=function(){return e.asyncIterator.next().then(a=>{if(e._iteratedOffset=e._iteratedOffset+a.value.data.length,!(e._iteratedOffset>=e._cachedOffset||a.done))return s();t()})};return s()}t()}).then(()=>this.asyncIterator.next().then(t=>(e._iteratedOffset=e._iteratedOffset+t.value.data.length,e._cachedOffset=e._iteratedOffset,e.cache.addListResult(t),t.done?new e._parent.CacheAsyncIteratorReturnResult(t.value):new e._parent.CacheAsyncIteratorYieldResult(t.value))))}return this.asyncIterator.next().then(t=>(e._iteratedOffset=e._iteratedOffset+t.value.data.length,e._cachedOffset=e._iteratedOffset,e.cache.addListResult(t),-1!=a||this.cache.isDone()||this.asyncIterator.next().then(t=>{e.cache.addListResult(t)}),t.done?new e._parent.CacheAsyncIteratorReturnResult(t.value):new e._parent.CacheAsyncIteratorYieldResult(t.value)))}},this.CacheAsyncIteratorYieldResult=class{constructor(t){this.value=t,this[r._VALUE]=t,this[r._DONE]=!1}},this.CacheAsyncIteratorReturnResult=class{constructor(t){this.value=t,this[r._VALUE]=t,this[r._DONE]=!0}};let s=this;this.cache=new t.DataCache,this._lastFetchParams=null,e.createOptimizedKeyMap&&(this.createOptimizedKeyMap=t=>e.createOptimizedKeyMap(t)),e.createOptimizedKeySet&&(this.createOptimizedKeySet=t=>e.createOptimizedKeySet(t)),e.addEventListener(r._MUTATE,t=>{s.cache.processMutations(t.detail),s.dispatchEvent(t)}),e.addEventListener(r._REFRESH,t=>{s.cache.reset(),s.dispatchEvent(t)})}containsKeys(t){let e=new Set,s=new Set,a=this.cache.getDataByKeys(t);if(t.keys.forEach(t=>{a.results.get(t)?e.add(t):s.add(t)}),0==s.size)return Promise.resolve({containsParameters:t,results:e});{let a={attributes:t.attributes,keys:s,scope:t.scope};return this.dataProvider.containsKeys(a).then(s=>(s.results.forEach(t=>{e.add(t)}),{containsParameters:t,results:e}))}}fetchByKeys(t){let e=new Map,s=new Set,a=this.cache.getDataByKeys(t);if(t.keys.forEach(t=>{let r=a.results.get(t);r?e.set(t,r):s.add(t)}),0==s.size)return Promise.resolve({fetchParameters:t,results:e});{let a={attributes:t.attributes,keys:s,scope:t.scope};return this.dataProvider.fetchByKeys(a).then(s=>(s.results.forEach((t,s)=>{e.set(s,t)}),{fetchParameters:t,results:e}))}}fetchByOffset(t){let e=t.size?t.size:r._DEFAULT_SIZE;if(this._compareLastFetchParameters(t)&&t.offset+e<=this.cache.getSize()){let s=JSON.parse(JSON.stringify(t));s.size=e;let a=this.cache.getDataByOffset(s);if(a)return Promise.resolve(a)}return this.dataProvider.fetchByOffset(t)}fetchFirst(t){this._compareLastFetchParameters(t)||this.cache.reset(),this._storeLastFetchParams(t);const e=this.dataProvider.fetchFirst(t);return new this.CacheAsyncIterable(this,e[Symbol.asyncIterator](),this.cache)}getCapability(t){let e=this.dataProvider.getCapability(t);return"fetchCapability"===t?{attributeFilter:null==e?void 0:e.attributeFilter,caching:"visitedByCurrentIterator"}:e}getTotalSize(){return!this._lastFetchParams.filterDef&&this.cache.isDone()?Promise.resolve(this.cache.getSize()):this.dataProvider.getTotalSize()}isEmpty(){return!this._lastFetchParams.filterDef&&this.cache.isDone()?0===this.cache.getSize()?"yes":"no":this.dataProvider.isEmpty()}_compareLastFetchParameters(e){return e=e||{},null!=this._lastFetchParams&&t.Object.compareValues(this._lastFetchParams.attributes,e.attributes||null)&&t.Object.compareValues(this._lastFetchParams.filterDef,this._getFilterDef(e.filterCriterion))&&t.Object.compareValues(this._lastFetchParams.sortCriteria,e.sortCriteria||null)}_storeLastFetchParams(t){t=t||{},this._lastFetchParams={},this._lastFetchParams.size=t.size,this._lastFetchParams.attributes=t.attributes?JSON.parse(JSON.stringify(t.attributes)):null,this._lastFetchParams.filterDef=this._getFilterDef(t.filterCriterion),this._lastFetchParams.sortCriteria=t.sortCriteria?JSON.parse(JSON.stringify(t.sortCriteria)):null}_getFilterDef(t){if(!t)return null;let e={};return Object.keys(t).forEach(function(s){"filter"!=s&&(e[s]=t[s])}),e}}return r._KEY="key",r._KEYS="keys",r._DATA="data",r._STARTINDEX="startIndex",r._SORT="sort",r._SORTCRITERIA="sortCriteria",r._FILTERCRITERION="filterCriterion",r._METADATA="metadata",r._ITEMS="items",r._FROM="from",r._OFFSET="offset",r._REFRESH="refresh",r._MUTATE="mutate",r._SIZE="size",r._FETCHPARAMETERS="fetchParameters",r._VALUE="value",r._DONE="done",r._RESULTS="results",r._CONTAINSPARAMETERS="containsParameters",r._DEFAULT_SIZE=25,r._CONTAINSKEYS="containsKeys",r._FETCHBYKEYS="fetchByKeys",r._FETCHBYOFFSET="fetchByOffset",r._FETCHFIRST="fetchFirst",r._ADDEVENTLISTENER="addEventListener",r._FETCHATTRIBUTES="attributes",e.EventTargetMixin.applyMixin(r),t._registerLegacyNamespaceProp("CachedIteratorResultsDataProvider",r),r});
//# sourceMappingURL=ojcachediteratorresultsdataprovider.js.map